<!doctype html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T√≠nh ƒêi·ªÉm T√≠ch L≈©y ƒêH Duy T√¢n</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet" />
  <style>
    /* CSS CHUNG CHO GIAO DI·ªÜN CH√çNH (ƒê√£ th√™m t·ª´ index.html ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªìng b·ªô) */
    :root {
      --main-red: #d9534f;
      --border-color: #dee2e6;
      --text-color: #333;
    }

    body {
      font-family: "Roboto", sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      /* ƒê·ªïi m√†u n·ªÅn cho ƒë·ªìng b·ªô */
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      box-sizing: border-box;
    }

    header {
      background: linear-gradient(135deg, #c0daf7, #e1e8ef, #738eab);
      color: var(--main-red);
      /* D√πng bi·∫øn m√†u ƒë·ªè ch√≠nh */
      padding: 0.5rem 0rem;
      /* Gi·∫£m padding */
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    header h1 {
      margin: 0;
      font-size: 1.5rem;
      font-weight: 700;
    }

    .container {
      max-width: 1000px;
      /* Gi·ªõi h·∫°n max-width */
      margin: 1rem auto;
      padding: 1rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      background-color: white;
      /* Th√™m background tr·∫Øng */
    }

    h2 {
      text-align: center;
      color: black;
      font-size: 1.5rem;
      font-weight: 500;
      margin-top: 0;
    }

    .table-container {
      max-height: 370px;
      overflow-y: auto;
      overflow-x: auto;
      margin-bottom: 1.5rem;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0 auto;
    }

    table thead {
      position: sticky;
      top: 0;
      z-index: 5;
    }

    table th,
    table td {
      padding: 1rem;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
      white-space: nowrap;
      /* Gi·ªØ ti√™u ƒë·ªÅ v√† n·ªôi dung tr√™n 1 d√≤ng */
    }

    table thead th {
      background-color: #f7f7f7;
      color: black;
      font-weight: 700;
    }

    table tbody tr:hover {
      background-color: #f9f9f9;
      transition: background-color 0.3s ease;
    }

    input[type="number"],
    input[type="text"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      text-align: center;
      box-sizing: border-box;
      font-size: 1rem;
      transition: border-color 0.2s;
    }

    input[type="number"]:focus,
    input[type="text"]:focus {
      border-color: var(--main-red);
      box-shadow: 0 0 0 2px rgba(217, 83, 79, 0.2);
      outline: none;
    }

    .button-group {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1.5rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
      text-transform: uppercase;
      text-decoration: none;
      color: black;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .switch-buttons .btn {
      background-color: #d8f5e2;
      /* M√†u nh·∫π cho n√∫t chuy·ªÉn tab */
      border: 1px solid #2ecc71;
    }

    .switch-buttons .btn:hover {
      background-color: #2ecc71;
      color: white;
    }


    .add-btn {
      background-color: #c5c1fb;
    }

    .calculate-btn {
      background-color: #2ecc71;
      color: white;
    }

    .delete-btn {
      background-color: #e74c3c;
      color: white;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
    }

    .instruction-btn {
      background-color: #f1c40f;
    }

    .result-card {
      text-align: center;
      padding: 2rem;
      background-color: #f9f9f9;
      border-radius: 12px;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .result-box {
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      margin-bottom: 1.5rem;
      background-color: white;
    }

    .result-card h3,
    .result-card h4 {
      margin: 0.75rem 0;
      color: black;
      font-size: 1.2rem;
      font-weight: 500;
    }

    .clear-btn {
      background-color: #f39c12;
      color: white;
    }

    .upload-btn {
      background-color: #3498db;
      color: white;
      cursor: pointer;
    }

    .hidden {
      display: none !important;
    }

    /* Custom Modal styles (Gi·ªØ nguy√™n) */
    .modal {
      display: none;
      position: fixed;
      z-index: 10;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.4);
      justify-content: center;
      align-items: center;
    }

    .modal-content {
      background-color: #fff;
      padding: 2rem;
      border-radius: 10px;
      text-align: center;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .modal-content p {
      margin-bottom: 1.5rem;
      font-size: 1.1rem;
      color: #333;
    }

    .modal-buttons .modal-btn {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-weight: 500;
      margin: 0 0.5rem;
    }

    .modal-buttons .confirm-btn {
      background-color: #2ecc71;
      color: white;
    }

    .modal-buttons .cancel-btn {
      background-color: #e74c3c;
      color: white;
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
        margin-top: 0.5rem;
        margin-bottom: 0.5rem;
      }

      header h1 {
        font-size: 1.2rem;
      }

      h2 {
        font-size: 1.3rem;
        margin-bottom: 1rem;
      }

      .table-container {
        max-height: 300px;
        margin-bottom: 1rem;
      }

      table {
        font-size: 0.9rem;
      }

      table th,
      table td {
        padding: 0.5rem;
      }

      input[type="number"],
      input[type="text"] {
        font-size: 0.9rem;
        padding: 0.5rem;
      }

      .button-group {
        gap: 0.5rem;
      }

      .btn {
        padding: 0.6rem 1rem;
        font-size: 0.8rem;
        flex: 1 1 auto;
        min-width: unset;
      }

      .delete-btn {
        padding: 0.3rem 0.6rem;
        font-size: 0.7rem;
      }

      .result-card h3,
      .result-card h4 {
        font-size: 1rem;
      }

      #fast-input-page input[type="checkbox"] {
        transform: scale(1.2);
      }
    }

    #fast-input-page {
      padding: 20px;
    }

    #fast-input-page h2 {
      margin-bottom: 20px;
    }

    #fast-input-page .table-container {
      max-width: 800px;
      margin: 0 auto 20px;
    }

    #fast-input-page input {
      width: 100%;
    }

    /* ===== CSS ƒê√É TH√äM ===== */
    #fast-input-page input[type="checkbox"] {
      width: auto;
      transform: scale(1.5);
      margin-top: 10px;
    }

    .demotion-reason {
      color: #e74c3c;
      font-weight: 700;
      font-size: 1.1rem;
      margin-top: 1rem;
    }

    .fast-result {
      margin-top: 15px;
      font-weight: bold;
    }

    /* ƒêi·ªÅu ch·ªânh l·∫°i cho table ·ªü trang input ch√≠nh */
    #input-page .table-container table td:nth-child(2) input,
    #input-page .table-container table td:nth-child(3) input {
      width: 100px;
    }

    /* ƒêi·ªÅu ch·ªânh l·∫°i cho table ·ªü trang nh·∫≠p nhanh */
    #fast-input-page .table-container table td input {
      width: 100%;
      min-width: 80px;
    }

    #subjects tr td:nth-child(1),
    #subjects tr td:nth-child(4) {
      width: 120px;
    }

    #subjects tr td:nth-child(2),
    #subjects tr td:nth-child(3) {
      width: 100px;
    }
  </style>
</head>

<body>
  <header>
    <h1>T√≠nh ƒêi·ªÉm T√≠ch L≈©y - ƒê·∫°i h·ªçc Duy T√¢n</h1>
  </header>

  <main class="container">
    <div class="switch-buttons">
      <button class="btn" onclick="showInputPage()">Nh·∫≠p ƒëi·ªÉm & t·∫£i file</button>
      <button class="btn" onclick="showFastInputPage()">X·∫øp Lo·∫°i h·ªçc l·ª±c</button>
    </div>

    <section id="input-page">
      <h2>Nh·∫≠p ƒêi·ªÉm C√°c H·ªçc Ph·∫ßn</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>M√£ L·ªõp</th>
              <th>S·ªë ƒêVHT</th>
              <th>ƒêi·ªÉm g·ªëc</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="subjects">
            <tr>
              <td><input type="text" placeholder="M√£ l·ªõp h·ªçc" /></td>
              <td><input type="number" step="1" min="1" placeholder="S·ªë t√≠n ch·ªâ"></td>
              <td><input type="number" step="0.1" min="0" max="10" placeholder="Thang ƒëi·ªÉm 10"></td>
              <td>
                <button class="btn delete-btn" onclick="deleteRow(this)">
                  X√≥a
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="button-group">
        <button class="btn add-btn" onclick="addRow()">+ Th√™m M√¥n</button>
        <button class="btn clear-btn" onclick="clearAllRows()">
          X√≥a T·∫•t C·∫£
        </button>
        <label class="btn upload-btn">
          Upload Files
          <input type="file" id="fileInput" accept=".xls,.xlsx" class="hidden" />
        </label>
        <button class="btn calculate-btn" onclick="calculate()">
          Xem K·∫øt Qu·∫£
        </button>
        <a href="huongdantinhdiemtichluy.html" class="btn instruction-btn" target="_blank">
          H∆∞·ªõng D·∫´n Upload Files
        </a>
      </div>
    </section>

    <section id="fast-input-page" class="hidden">
      <h2>X·∫øp lo·∫°i h·ªçc l·ª±c ƒë·ªëi v·ªõi sinh vi√™n nƒÉm cu·ªëi</h2>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>T·ªïng s·ªë ƒêVHT to√†n Kh√≥a h·ªçc</th>
              <th>Trung b√¨nh ƒêi·ªÉm g·ªëc to√†n Kh√≥a h·ªçc (10)</th>
              <th>ƒêi·ªÉm TB T√≠ch l≈©y to√†n Kh√≥a h·ªçc (4)</th>
              <th>S·ªë TC h·ªçc l·∫°i/gh√©p</th>
              <th>B·ªã k·ª∑ lu·∫≠t?</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><input type="number" id="fastTotalCredits" placeholder="T·ªïng t√≠n ch·ªâ"></td>
              <td><input type="number" id="fastAvg10" step="0.01" min="0.00" max="10" placeholder="ƒêi·ªÉm 10"></td>
              <td><input type="number" id="fastAvg4" step="0.01" min="0.00" max="4" placeholder="ƒêi·ªÉm 4"></td>
              <td><input type="number" id="fastRetakenCredits" min="0" placeholder="T√≠n ch·ªâ h·ªçc l·∫°i"></td>
              <td><input type="checkbox" id="fastDisciplined"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="button-group">
        <button class="btn calculate-btn" onclick="fastCalculate()">Xem K·∫øt Qu·∫£</button>
        <button class="btn clear-btn" onclick="fastClear()">X√≥a</button>
      </div>
    </section>
    <section id="result-page" class="hidden">
      <div class="result-card">
        <h2>K·∫æT QU·∫¢</h2>
        <div class="result-box">
          <h3 id="totalCredits"></h3>
          <h3 id="avg10"></h3>
          <h3 id="avg4"></h3>
          <h3 id="rank"></h3>
          <h4 id="demotionReason" class="demotion-reason"></h4>
        </div>
        <div class="button-group">
          <button class="btn back-btn" onclick="goBack()">Quay L·∫°i</button>
        </div>
      </div>
    </section>
  </main>

  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <p id="modal-message"></p>
      <div class="modal-buttons">
        <button id="modal-cancel-btn" class="btn modal-btn cancel-btn">H·ªßy</button>
        <button id="modal-confirm-btn" class="btn modal-btn confirm-btn">OK</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Bi·∫øn ƒë·ªÉ l∆∞u tr·∫°ng th√°i trang hi·ªán t·∫°i, gi√∫p n√∫t "Quay l·∫°i" ho·∫°t ƒë·ªông ƒë√∫ng
    let currentPage = 'input-page';

    // Function ƒë·ªÉ hi·ªÉn th·ªã modal th√¥ng b√°o t√πy ch·ªânh
    function showModal(message, type = 'alert', onConfirm = null) {
      const modal = document.getElementById('custom-modal');
      const messageElement = document.getElementById('modal-message');
      const confirmBtn = document.getElementById('modal-confirm-btn');
      const cancelBtn = document.getElementById('modal-cancel-btn');

      messageElement.innerText = message;

      if (type === 'confirm') {
        confirmBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        confirmBtn.onclick = () => {
          onConfirm();
          modal.style.display = 'none';
        };
        cancelBtn.onclick = () => {
          modal.style.display = 'none';
        };
      } else {
        confirmBtn.style.display = 'none';
        cancelBtn.style.display = 'none';
        // Th√™m s·ª± ki·ªán click ngo√†i modal ƒë·ªÉ t·∫Øt
        modal.onclick = (event) => {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        };
      }

      modal.style.display = 'flex';
    }

    function addRow(subjectCode = '', credits = '', score10 = '') {
      const tbody = document.getElementById("subjects");
      const existingSubjectCodes = Array.from(tbody.querySelectorAll('input[type="text"]'))
        .map(input => input.value.trim().toUpperCase());

      if (subjectCode && existingSubjectCodes.includes(subjectCode.trim().toUpperCase())) {
        showModal(`M√£ l·ªõp "${subjectCode}" ƒë√£ t·ªìn t·∫°i. Vui l√≤ng nh·∫≠p m√£ l·ªõp kh√°c.`);
        return;
      }

      const row = document.createElement("tr");
      row.innerHTML = `
    <td><input type="text" placeholder="M√£ l·ªõp" value="${subjectCode}"></td>
    <td><input type="number" step="1" min="1" value="${credits}" placeholder="S·ªë t√≠n ch·ªâ"></td>
    <td><input type="number" step="0.1" min="0" max="10" value="${score10}" placeholder="Thang ƒëi·ªÉm 10"></td>
    <td><button class="btn delete-btn" onclick="deleteRow(this)">X√≥a</button></td>
  `;

      tbody.appendChild(row);

      row.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }

    function deleteRow(btn) {
      const row = btn.parentNode.parentNode;
      const tbody = document.getElementById("subjects");
      // Ph·∫£i c√≥ √≠t nh·∫•t 1 h√†ng ƒë·ªÉ gi·ªØ form
      if (tbody.rows.length > 1) {
        tbody.removeChild(row);
      } else {
        showModal("Ph·∫£i c√≥ √≠t nh·∫•t 1 m√¥n h·ªçc!");
      }
    }

    // H√†m n√†y gi·ªù s·∫Ω ch·ªâ ƒë∆∞·ª£c g·ªçi t·ª´ n√∫t "X√≥a T·∫•t C·∫£"
    function clearAllRows() {
      showModal("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t·∫•t c·∫£ c√°c m√¥n h·ªçc ƒë√£ nh·∫≠p kh√¥ng?", 'confirm', () => {
        clearAllRowsWithoutConfirm();
      });
    }

    // H√†m ƒë·ªÉ x√≥a t·∫•t c·∫£ c√°c h√†ng m√† kh√¥ng c·∫ßn x√°c nh·∫≠n
    function clearAllRowsWithoutConfirm() {
      const tbody = document.getElementById("subjects");
      while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
      }
      addRow(); // Th√™m l·∫°i 1 h√†ng tr·ªëng

      const fileInput = document.getElementById("fileInput");
      if (fileInput) {
        fileInput.value = "";
      }
    }

    // C·∫≠p nh·∫≠t h√†m convertTo4() ƒë·ªÉ s·ª≠ d·ª•ng b·∫£ng quy ƒë·ªïi m·ªõi
    function convertTo4(score10) {
      if (score10 >= 9.5) return 4.0; // A+
      if (score10 >= 8.5) return 4.0; // A
      if (score10 >= 8.0) return 3.65; // A-
      if (score10 >= 7.5) return 3.33; // B+
      if (score10 >= 7.0) return 3.0; // B
      if (score10 >= 6.5) return 2.65; // B-
      if (score10 >= 6.0) return 2.33; // C+
      if (score10 >= 5.5) return 2.0; // C
      if (score10 >= 4.5) return 1.65; // C-
      if (score10 >= 4.0) return 1.0; // D
      return 0.0; // F
    }

    function getRank(avg4) {
      if (avg4 >= 3.6) return "Xu·∫•t s·∫Øc";
      if (avg4 >= 3.2) return "Gi·ªèi";
      if (avg4 >= 2.5) return "Kh√°";
      if (avg4 >= 2.0) return "Trung b√¨nh";
      return "Y·∫øu/K√©m";
    }

    function calculate() {
      const rows = document.querySelectorAll("#subjects tr");
      let totalCredits = 0,
        sum10 = 0,
        sum4 = 0;
      let hasValidData = false;

      rows.forEach((r) => {
        // C·∫ßn ƒë·∫£m b·∫£o l·∫•y ƒë√∫ng input trong cell
        const creditsInput = r.children[1].querySelector('input');
        const score10Input = r.children[2].querySelector('input');

        const credits = parseFloat(creditsInput ? creditsInput.value : 0) || 0;
        const score10 = parseFloat(score10Input ? score10Input.value : 0) || 0;

        if (credits > 0 && score10 >= 0 && score10 <= 10) {
          hasValidData = true;
          const score4 = convertTo4(score10);

          totalCredits += credits;
          sum10 += score10 * credits;
          sum4 += score4 * credits;
        }
      });

      if (!hasValidData || totalCredits === 0) {
        showModal(
          "Vui l√≤ng nh·∫≠p s·ªë t√≠n ch·ªâ v√† ƒëi·ªÉm h·ª£p l·ªá cho √≠t nh·∫•t m·ªôt m√¥n h·ªçc!"
        );
        return;
      }

      const avg10 = (sum10 / totalCredits).toFixed(2);
      const avg4 = (sum4 / totalCredits).toFixed(2);
      const rank = getRank(parseFloat(avg4));

      document.getElementById("totalCredits").innerText =
        `üìö T·ªïng s·ªë ƒê∆°n v·ªã H·ªçc t·∫≠p (ƒêVHT) to√†n Kh√≥a h·ªçc: ${totalCredits}`;
      document.getElementById("avg10").innerText =
        `üìò Trung b√¨nh ƒêi·ªÉm g·ªëc to√†n Kh√≥a h·ªçc: ${avg10}`;
      document.getElementById("avg4").innerText =
        `üìó ƒêi·ªÉm Trung b√¨nh T√≠ch l≈©y to√†n Kh√≥a h·ªçc: ${avg4}`;
      document.getElementById("rank").innerText = `üèÜ X·∫øp lo·∫°i h·ªçc l·ª±c ƒë·ªëi v·ªõi sinh vi√™n nƒÉm cu·ªëi: ${rank}`;

      // X√≥a l√Ω do h·∫° b·∫≠c (n·∫øu c√≥ t·ª´ l·∫ßn t√≠nh tr∆∞·ªõc)
      document.getElementById("demotionReason").innerText = "";

      // L∆∞u l·∫°i trang hi·ªán t·∫°i
      currentPage = 'input-page';

      document.getElementById("input-page").classList.add("hidden");
      document.getElementById("fast-input-page").classList.add("hidden");
      document.getElementById("result-page").classList.remove("hidden");
    }

    function goBack() {
      document.getElementById("result-page").classList.add("hidden");
      document.getElementById("demotionReason").innerText = "";

      if (currentPage === 'input-page') {
        document.getElementById("input-page").classList.remove("hidden");
      } else if (currentPage === 'fast-input-page') {
        document.getElementById("fast-input-page").classList.remove("hidden");
      }
    }

    document.getElementById('fileInput').addEventListener('change', (event) => {
      const file = event.target.files[0];
      if (!file) {
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array' });
          const firstSheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[firstSheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

          if (jsonData.length < 2) {
            showModal("T·ªáp kh√¥ng c√≥ d·ªØ li·ªáu!");
            return;
          }

          let subjectCodeIndex = -1, creditsIndex = -1, scoreIndex = -1, letterGradeIndex = -1;
          let dataStartIndex = -1;

          // T√¨m h√†ng ch·ª©a ti√™u ƒë·ªÅ
          for (let i = 0; i < jsonData.length; i++) {
            const headers = jsonData[i];
            if (Array.isArray(headers)) {
              // Chuy·ªÉn ti√™u ƒë·ªÅ v·ªÅ ch·ªØ hoa v√† lo·∫°i b·ªè kho·∫£ng tr·∫Øng th·ª´a ƒë·ªÉ t√¨m ki·∫øm
              const upperHeaders = headers.map(h => h ? h.toString().trim().toUpperCase() : '');
              subjectCodeIndex = upperHeaders.indexOf('M√É L·ªöP');
              creditsIndex = upperHeaders.indexOf('S·ªê ƒêVHT');
              scoreIndex = upperHeaders.indexOf('ƒêI·ªÇM G·ªêC');
              letterGradeIndex = upperHeaders.indexOf('ƒêI·ªÇM CH·ªÆ');
            }

            // Y√™u c·∫ßu b·∫Øt bu·ªôc 4 c·ªôt n√†y
            if (subjectCodeIndex !== -1 && creditsIndex !== -1 && scoreIndex !== -1 && letterGradeIndex !== -1) {
              dataStartIndex = i + 1;
              break;
            }
          }

          if (dataStartIndex === -1) {
            showModal("T·ªáp Excel kh√¥ng c√≥ ƒë·ªß c√°c c·ªôt 'M√£ L·ªõp', 'S·ªë ƒêVHT', 'ƒêi·ªÉm g·ªëc', v√† 'ƒêi·ªÉm ch·ªØ'. Vui l√≤ng ki·ªÉm tra l·∫°i ti√™u ƒë·ªÅ c·ªôt.");
            return;
          }

          // X√≥a d·ªØ li·ªáu c≈© v√† chu·∫©n b·ªã th√™m d·ªØ li·ªáu m·ªõi
          const tbody = document.getElementById("subjects");
          while (tbody.firstChild) {
            tbody.removeChild(tbody.firstChild);
          }

          const existingSubjectCodes = new Set();
          let hasAddedData = false;
          const allowedGrades = new Set(['A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-', 'D']);

          // ƒê·ªçc d·ªØ li·ªáu t·ª´ file
          for (let i = dataStartIndex; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row.length > 0) {
              const subjectCode = row[subjectCodeIndex] ? row[subjectCodeIndex].toString().trim() : '';
              const credits = parseFloat(row[creditsIndex]) || 0;
              const score10 = parseFloat(row[scoreIndex]) || 0;
              const letterGrade = row[letterGradeIndex] ? row[letterGradeIndex].toString().trim().toUpperCase() : '';

              // Ch·ªâ th√™m v√†o n·∫øu ƒêi·ªÉm ch·ªØ h·ª£p l·ªá V√Ä M√£ l·ªõp + T√≠n ch·ªâ > 0 V√Ä ƒêi·ªÉm 10 n·∫±m trong [0, 10]
              if (allowedGrades.has(letterGrade) && subjectCode && credits > 0 && score10 >= 0 && score10 <= 10) {
                const codeToCompare = subjectCode.toUpperCase();
                if (existingSubjectCodes.has(codeToCompare)) {
                  console.warn(`M√£ m√¥n "${subjectCode}" b·ªã tr√πng l·∫∑p trong file v√† ƒë√£ b·ªã b·ªè qua.`);
                  continue;
                }
                existingSubjectCodes.add(codeToCompare);
                addRow(subjectCode, credits, score10);
                hasAddedData = true;
              } else {
                console.log(`B·ªè qua m√¥n ${subjectCode} v√¨ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá (ƒêi·ªÉm ch·ªØ: ${letterGrade}, TC: ${credits}, ƒêi·ªÉm: ${score10}).`);
              }
            }
          }

          if (!hasAddedData) {
            addRow();
            showModal("Kh√¥ng c√≥ d·ªØ li·ªáu h·ª£p l·ªá (ƒêi·ªÉm ch·ªØ A, B, C, D) ƒë∆∞·ª£c t√¨m th·∫•y trong t·ªáp Excel.");
          }
        } catch (error) {
          console.error(error);
          showModal("L·ªói khi x·ª≠ l√Ω t·ªáp Excel. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng file.");
        }
      };
      reader.readAsArrayBuffer(file);
      // Reset input file ƒë·ªÉ c√≥ th·ªÉ upload l·∫°i c√πng m·ªôt file
      event.target.value = null;
    });

    // H√†m ƒë·ªÉ hi·ªÉn th·ªã trang nh·∫≠p li·ªáu nhanh v√† x√≥a d·ªØ li·ªáu c≈©
    function showFastInputPage() {
      clearAllRowsWithoutConfirm();
      document.getElementById("input-page").classList.add("hidden");
      document.getElementById("result-page").classList.add("hidden");
      document.getElementById("fast-input-page").classList.remove("hidden");
    }

    // H√†m ƒë·ªÉ hi·ªÉn th·ªã trang nh·∫≠p li·ªáu ch√≠nh v√† x√≥a d·ªØ li·ªáu c≈©
    function showInputPage() {
      fastClear();
      document.getElementById("fast-input-page").classList.add("hidden");
      document.getElementById("result-page").classList.add("hidden");
      document.getElementById("input-page").classList.remove("hidden");
    }

    // ===== H√ÄM ƒê√É C·∫¨P NH·∫¨T (fastCalculate) =====
    function fastCalculate() {
      const totalCredits = parseFloat(document.getElementById("fastTotalCredits").value) || 0;
      const avg10Input = document.getElementById("fastAvg10");
      const avg4Input = document.getElementById("fastAvg4");
      const retakenCredits = parseFloat(document.getElementById("fastRetakenCredits").value) || 0;
      const isDisciplined = document.getElementById("fastDisciplined").checked;

      let avg10 = parseFloat(avg10Input.value);
      let avg4 = parseFloat(avg4Input.value);

      if (isNaN(avg10) || avg10 < 0 || avg10 > 10) {
        showModal("Trung b√¨nh g·ªëc (thang ƒëi·ªÉm 10) ph·∫£i n·∫±m trong kho·∫£ng t·ª´ 0.00 ƒë·∫øn 10.00.");
        return;
      }

      if (isNaN(avg4) || avg4 < 0 || avg4 > 4) {
        showModal("Trung b√¨nh t√≠ch l≈©y (thang ƒëi·ªÉm 4) ph·∫£i n·∫±m trong kho·∫£ng t·ª´ 0.00 ƒë·∫øn 4.00.");
        return;
      }

      if (totalCredits <= 0) {
        showModal("Vui l√≤ng nh·∫≠p T·ªïng s·ªë ƒêVHT to√†n Kh√≥a h·ªçc l·ªõn h∆°n 0.");
        return;
      }

      const initialRank = getRank(avg4);
      let finalRank = initialRank;
      let reason = "";
      let retakenPercentage = 0;

      if (totalCredits > 0) {
        retakenPercentage = (retakenCredits / totalCredits) * 100;
      }

      const needsDemotion = (retakenPercentage > 5) || isDisciplined;

      if (needsDemotion && (initialRank === "Xu·∫•t s·∫Øc" || initialRank === "Gi·ªèi")) {
        if (initialRank === "Xu·∫•t s·∫Øc") {
          finalRank = "Gi·ªèi";
        } else if (initialRank === "Gi·ªèi") {
          finalRank = "Kh√°";
        }

        // X√¢y d·ª±ng chu·ªói l√Ω do
        if (retakenPercentage > 5 && isDisciplined) {
          reason = `L√Ω do h·∫° b·∫≠c: B·ªã k·ª∑ lu·∫≠t v√† c√≥ s·ªë TC h·ªçc l·∫°i/gh√©p v∆∞·ª£t qu√° 5% (${retakenPercentage.toFixed(2)}%).`;
        } else if (retakenPercentage > 5) {
          reason = `L√Ω do h·∫° b·∫≠c: S·ªë TC h·ªçc l·∫°i/gh√©p (${retakenCredits} TC) v∆∞·ª£t qu√° 5% t·ªïng s·ªë t√≠n ch·ªâ (${retakenPercentage.toFixed(2)}%).`;
        } else if (isDisciplined) {
          reason = "L√Ω do h·∫° b·∫≠c: ƒê√£ b·ªã k·ª∑ lu·∫≠t t·ª´ m·ª©c c·∫£nh c√°o tr·ªü l√™n.";
        }
      }

      document.getElementById("totalCredits").innerText = `üìö T·ªïng s·ªë ƒê∆°n v·ªã H·ªçc t·∫≠p (ƒêVHT) to√†n Kh√≥a h·ªçc: ${totalCredits || 'N/A'}`;
      document.getElementById("avg10").innerText = `üìò Trung b√¨nh ƒêi·ªÉm g·ªëc to√†n Kh√≥a h·ªçc: ${avg10.toFixed(2)}`;
      document.getElementById("avg4").innerText = `üìó ƒêi·ªÉm Trung b√¨nh T√≠ch l≈©y to√†n Kh√≥a h·ªçc: ${avg4.toFixed(2)}`;
      document.getElementById("rank").innerText = `üèÜ X·∫øp lo·∫°i h·ªçc l·ª±c ƒë·ªëi v·ªõi sinh vi√™n nƒÉm cu·ªëi: ${finalRank}`;
      document.getElementById("demotionReason").innerText = reason; // Hi·ªÉn th·ªã l√Ω do

      // L∆∞u l·∫°i trang hi·ªán t·∫°i
      currentPage = 'fast-input-page';

      document.getElementById("fast-input-page").classList.add("hidden");
      document.getElementById("input-page").classList.add("hidden");
      document.getElementById("result-page").classList.remove("hidden");
    }

    // ===== H√ÄM ƒê√É C·∫¨P NH·∫¨T (fastClear) =====
    function fastClear() {
      document.getElementById("fastTotalCredits").value = "";
      document.getElementById("fastAvg10").value = "";
      document.getElementById("fastAvg4").value = "";
      document.getElementById("fastRetakenCredits").value = "";
      document.getElementById("fastDisciplined").checked = false;
      document.getElementById("result-page").classList.add("hidden");
      // X√≥a c·∫£ l√Ω do khi x√≥a form
      document.getElementById("demotionReason").innerText = "";
    }

    // Kh·ªüi t·∫°o h√†ng ƒë·∫ßu ti√™n khi t·∫£i trang
    document.addEventListener('DOMContentLoaded', () => {
      // Ch·ªâ th√™m h√†ng n·∫øu ch∆∞a c√≥ h√†ng n√†o (v√≠ d·ª•, do l·ªói trong code tr∆∞·ªõc)
      const tbody = document.getElementById("subjects");
      if (tbody.rows.length === 0) {
        addRow();
      } else {
        // ƒê·∫£m b·∫£o ch·ªâ c√≥ 1 h√†ng tr·ªëng ban ƒë·∫ßu
        while (tbody.rows.length > 1) {
          tbody.removeChild(tbody.lastChild);
        }
      }
    });
  </script>
</body>

</html>
