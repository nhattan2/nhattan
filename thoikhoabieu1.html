<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫Øp X·∫øp L·ªãch T√≠n Ch·ªâ - B·∫£n Full Option</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f8fafc;
            --primary: #be123c;
            --text: #334155;
            --card-bg: #ffffff;
            --border-radius: 10px;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            margin: 0;
            background: var(--bg-body);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: 50px;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        h1 {
            font-size: 1.1rem;
            color: var(--primary);
            margin: 0;
            text-transform: uppercase;
            font-weight: 800;
        }

        .app-container {
            flex: 1;
            padding: 15px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .toolbar {
            background: white;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .total-badge {
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-weight: bold;
        }

        .phase-stat {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            color: white;
        }

        .btn-tool {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .btn-tool:hover {
            transform: translateY(-1px);
            filter: brightness(1.1);
        }

        .table-card {
            background: white;
            border-radius: var(--border-radius);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            border: 1px solid #e2e8f0;
        }

        .table-scroll {
            flex: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f1f5f9;
            padding: 12px 10px;
            font-size: 0.75rem;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 5;
            border-bottom: 2px solid #cbd5e1;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
        }

        .row-warning {
            background-color: #fff1f2 !important;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(2px);
        }

        .modal-box {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 1300px;
            height: 85vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            background: #f8fafc;
            overflow: hidden;
        }

        .lookup-left {
            width: 180px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            justify-content: center;
        }

        .lookup-right {
            flex: 1;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            overflow: auto;
        }

        .btn-giant {
            background: #6366f1;
            color: white;
            border: none;
            padding: 30px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .btn-delete-all {
            background: #ef4444;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
        }

        .tkb-container {
            display: flex;
            gap: 15px;
            padding: 15px;
            height: 100%;
            width: 100%;
        }

        .tkb-box {
            flex: 1;
            background: white;
            border: 1px solid #cbd5e1;
            display: flex;
            flex-direction: column;
            border-radius: 8px;
            overflow: hidden;
        }

        .tkb-head {
            padding: 8px;
            text-align: center;
            color: white;
            font-weight: bold;
        }

        .tkb-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
            font-size: 0.7rem;
        }

        .tkb-table th,
        .tkb-table td {
            border: 1px solid #e2e8f0;
            padding: 4px;
            height: 85px;
            vertical-align: top;
        }

        .tkb-table th {
            height: 30px;
            background: #f8fafc;
        }

        .tkb-card {
            background: #ecfccb;
            border-left: 3px solid #65a30d;
            padding: 3px;
            margin-bottom: 2px;
            border-radius: 2px;
        }
    </style>
</head>

<body>
    <header>
        <h1>S·∫Øp X·∫øp L·ªãch T√≠n Ch·ªâ</h1>
    </header>

    <div class="app-container">
        <div class="toolbar">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="font-weight:700;">T·ªïng: <span class="total-badge" id="totalCredits">0</span> TC</div>
                <div class="phase-stat" style="background: #f97316;">GD1: <span id="statGD1">0</span> bu·ªïi</div>
                <div class="phase-stat" style="background: #3b82f6;">GD2: <span id="statGD2">0</span> bu·ªïi</div>
            </div>
            <div style="display:flex; gap:8px;">
                <button class="btn-tool" style="background:#059669;" onclick="openLookupModal()"><i
                        class="fas fa-search"></i> Ch·ªçn m√¥n</button>
                <button class="btn-tool" style="background:#f59e0b;" onclick="generateTKB()"><i
                        class="far fa-calendar-alt"></i> TKB</button>
                <button class="btn-tool" style="background:#ec4899;" onclick="snapTable()"><i class="fas fa-camera"></i>
                    Ch·ª•p b·∫£ng</button>
                <button class="btn-tool" style="background:#0891b2;" onclick="exportData()"><i class="fas fa-save"></i>
                    L∆∞u</button>
                <button class="btn-tool" style="background:#475569;"
                    onclick="document.getElementById('fileInput').click()"><i class="fas fa-folder-open"></i>
                    M·ªü</button>
                <input type="file" id="fileInput" hidden accept=".json" onchange="importData(this)">
                <button class="btn-tool" style="background:#dc2626;" onclick="clearAll()"><i class="fas fa-trash"></i>
                    X√≥a h·∫øt</button>
            </div>
        </div>

        <div class="table-card" id="mainTableArea">
            <div class="table-scroll">
                <table>
                    <thead>
                        <tr>
                            <th width="10%">M√£ ƒêK</th>
                            <th width="12%">M√£ L·ªõp</th>
                            <th>T√™n M√¥n</th>
                            <th width="8%">Tu·∫ßn</th>
                            <th width="15%">L·ªãch H·ªçc</th>
                            <th width="18%">ƒê·ªãa ƒêi·ªÉm</th>
                            <th width="15%">Gi·∫£ng Vi√™n</th>
                            <th width="5%"></th>
                        </tr>
                    </thead>
                    <tbody id="mainTableBody">
                        <tr>
                            <td colspan="8" style="text-align:center; padding:50px; color:#94a3b8;">Tr·ªëng. H√£y b·∫•m "Ch·ªçn
                                m√¥n" v√† D√°n d·ªØ li·ªáu.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="lookupModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h3 style="margin:0;"><i class="fas fa-search"></i> Tra c·ª©u (∆Øu ti√™n: Gƒê √≠t bu·ªïi > Ch·ªó √≠t)</h3>
                <button onclick="closeModal('lookupModal')"
                    style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="lookup-left">
                    <button class="btn-giant" onclick="handlePaste()"><i class="fas fa-clipboard"></i> D√ÅN</button>
                    <button class="btn-delete-all"
                        onclick="document.getElementById('lookupTableBody').innerHTML=''">X√ìA</button>
                </div>
                <div class="lookup-right">
                    <table>
                        <thead>
                            <tr>
                                <th>M√£ ƒêK</th>
                                <th>M√£ L·ªõp</th>
                                <th>T√™n M√¥n</th>
                                <th>Ch·ªó</th>
                                <th>Tu·∫ßn</th>
                                <th>L·ªãch h·ªçc</th>
                                <th>Gi·∫£ng vi√™n</th>
                                <th>Ch·ªçn</th>
                            </tr>
                        </thead>
                        <tbody id="lookupTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="creditModal" class="modal-overlay">
        <div class="modal-box" style="max-width:350px; height:auto; padding:20px;">
            <h3 style="margin-top:0;">S·ªë t√≠n ch·ªâ</h3>
            <p id="targetSub" style="font-weight:bold; color:#be123c;"></p>
            <select id="creditInput" style="width:100%; padding:10px; border-radius:5px;">
                <option value="3">3 T√≠n ch·ªâ</option>
                <option value="2" selected>2 T√≠n ch·ªâ</option>
                <option value="1">1 T√≠n ch·ªâ</option>
                <option value="4">4 T√≠n ch·ªâ</option>
            </select>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-tool" style="background:#059669; flex:1; justify-content:center;"
                    onclick="addSubject()">X√°c nh·∫≠n</button>
                <button class="btn-tool" style="background:#94a3b8; flex:1; justify-content:center;"
                    onclick="closeModal('creditModal')">H·ªßy</button>
            </div>
        </div>
    </div>

    <div id="tkbModal" class="modal-overlay">
        <div class="modal-box" style="max-width:1400px; height:90vh;">
            <div class="modal-header">
                <h3>Th·ªùi kh√≥a bi·ªÉu d·ª± ki·∫øn</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn-tool" style="background:#0ea5e9;" onclick="snapElement('tkbCaptureArea')">üì∏ Ch·ª•p
                        ·∫£nh</button>
                    <button onclick="closeModal('tkbModal')"
                        style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
                </div>
            </div>
            <div id="tkbCaptureArea" style="background:#f8fafc; flex:1; overflow:auto;">
                <div id="tkbContent" class="tkb-container"></div>
            </div>
        </div>
    </div>

    <script>
        let mySchedule = [];
        let tempSubject = null;

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        function openLookupModal() {
            document.getElementById('lookupTableBody').innerHTML = '';
            openModal('lookupModal');
        }

        function getCourseIdentity(classCode) {
            const match = classCode.match(/^(.+?)\s([A-Z]+)(\d*)$/);
            if (!match) return { base: classCode, type: 'LT' };
            return {
                base: match[1].trim(),
                type: match[3] === "" ? "LT" : "TH"
            };
        }

        function getPhase(weeksStr) {
            const startWeek = parseInt(weeksStr.split('-')[0]);
            return (startWeek <= 30) ? 1 : 2;
        }

        function countSessions() {
            let gd1 = 0, gd2 = 0;
            mySchedule.forEach(sub => {
                const p = getPhase(sub.weeks);
                if (p === 1) gd1 += sub.sessions.length;
                else gd2 += sub.sessions.length;
            });
            return { gd1, gd2 };
        }

        async function handlePaste() {
            try {
                const text = await navigator.clipboard.readText();
                if (!text) return alert("Clipboard tr·ªëng!");
                const parsed = parseData(text);
                renderLookup(parsed);
            } catch (e) { alert("Vui l√≤ng cho ph√©p quy·ªÅn truy c·∫≠p Clipboard!"); }
        }

        // --- GI·ªÆ NGUY√äN PARSE DATA G·ªêC C·ª¶A B·∫†N (C√ì CH·ªñ) ---
        function parseData(raw) {
            const results = [];
            let subjectNameHeader = "M√¥n h·ªçc";
            let nameMatch = raw.match(/M√¥n h·ªçc\s+([A-Z√Ä-·ª∏\s]+)\n/i) || raw.match(/Th√¥ng tin m√¥n h·ªçc\s+([A-Z√Ä-·ª∏\s]+)\n/i);
            if (nameMatch) subjectNameHeader = nameMatch[1].replace(/[A-Z]{2,}\s\d{3,}/, "").replace(":", "").trim();

            raw = raw.replace(/Tu·∫ßn h·ªßy:.*(\n|$)/g, " ").replace(/H·ªßy \d+.*(\n|$)/g, " ");
            const classRegex = /([A-Z]{2,}-\d{3,}\s[A-Z0-9]+|[A-Z]{2,}\s\d{3,}\s[A-Z0-9]+)/g;
            let matches = [...raw.matchAll(classRegex)];

            const locMap = {
                "H√≤a Kh√°nh": "120 Ho√†ng Minh Th·∫£o", "Phan Thanh": "209 Phan Thanh",
                "K7/25 Quang Trung": "K7/25 Quang Trung", "03 Quang Trung": "03 Quang Trung",
                "Quang Trung": "K7/25 Quang Trung", "254 Nguy·ªÖn VƒÉn Linh": "254 Nguy·ªÖn VƒÉn Linh",
                "137 Nguy·ªÖn VƒÉn Linh": "137 Nguy·ªÖn VƒÉn Linh", "Nguy·ªÖn VƒÉn Linh": "254 Nguy·ªÖn VƒÉn Linh",
                "Phan VƒÉn Tr·ªã": "78 Phan VƒÉn Tr·ªã", "Online": "Online"
            };

            matches.forEach((m, i) => {
                let block = raw.substring(m.index, matches[i + 1] ? matches[i + 1].index : raw.length);
                let regCode = (block.match(/\b[A-Z0-9]{10,}\b/) || ["---"])[0];
                let seat = (block.match(/(LEC|LAB|WOR|DEM)\s+(\d+)/) || [0, 0, 0])[2];
                let weeks = (block.match(/(\d+)--(\d+)/) || [0, 33, 40]);

                let teacher = "Ch∆∞a r√µ";
                let parts = block.split(/\n|\t|\s{3,}/).map(p => p.trim()).filter(p => p.length > 5);
                const statusList = ["C√íN H·∫†N", "H·∫æT H·∫†N", "L·ªöP H·ªåC", "ƒê√É ƒêƒÇNG K√ù"];

                for (let p of parts) {
                    if (p === p.toUpperCase() && !/\d/.test(p) && !p.includes("ƒê·ªäA ƒêI·ªÇM") && !p.includes("LEC") && !p.includes("ONLINE") && !statusList.some(status => p.includes(status)) && p.split(' ').length >= 2) {
                        teacher = p; break;
                    }
                }

                const timeRegex = /(T\d|CN)[\s:]*(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/g;
                let sessions = [];
                let tMatches = [...block.matchAll(timeRegex)];
                let lastTimeIdx = tMatches.length > 0 ? tMatches[tMatches.length - 1].index : 0;
                let foundLocs = [];
                Object.keys(locMap).forEach(key => {
                    let pos = -1;
                    while ((pos = block.indexOf(key, pos + 1)) !== -1) {
                        if (pos > lastTimeIdx) foundLocs.push({ pos, text: locMap[key] });
                    }
                });
                foundLocs.sort((a, b) => a.pos - b.pos);
                let finalLocs = foundLocs.slice(-tMatches.length);

                tMatches.forEach((tm, idx) => {
                    let loc = "Ch∆∞a r√µ";
                    if (finalLocs.length > 0) loc = finalLocs[idx] ? finalLocs[idx].text : finalLocs[finalLocs.length - 1].text;
                    sessions.push({ day: tm[1], time: `${tm[2]}-${tm[3]}`, loc, start: tm[2] });
                });

                if (sessions.length > 0) {
                    results.push({ regCode, classCode: m[0], name: subjectNameHeader, seat, weeks: `${weeks[1]}-${weeks[2]}`, teacher, sessions });
                }
            });
            return results;
        }

        // --- C·∫¨P NH·∫¨T RENDER LOOKUP: ∆ØU TI√äN Gƒê R·∫¢NH + CH·ªñ √çT ---
        function renderLookup(data) {
            const stats = countSessions();
            const existingIdents = mySchedule.map(s => {
                const id = getCourseIdentity(s.classCode);
                return `${id.base}|${id.type}`;
            });

            let filtered = data.filter(item => {
                const id = getCourseIdentity(item.classCode);
                return !existingIdents.includes(`${id.base}|${id.type}`);
            });

            if (data.length > filtered.length) {
                alert(`ƒê√£ l·ªçc b·ªè ${data.length - filtered.length} m√£ l·ªõp v√¨ m√¥n ƒë√≥ ƒë√£ c√≥ trong TKB r·ªìi!`);
            }

            // Thu·∫≠t to√°n s·∫Øp x·∫øp ƒëa t·∫ßng:
            filtered.sort((a, b) => {
                const pA = getPhase(a.weeks);
                const pB = getPhase(b.weeks);
                const loadA = (pA === 1) ? stats.gd1 : stats.gd2;
                const loadB = (pB === 1) ? stats.gd1 : stats.gd2;

                // T·∫ßng 1: ∆Øu ti√™n Giai ƒëo·∫°n r·∫£nh h∆°n
                if (loadA !== loadB) {
                    return loadA - loadB;
                }

                // T·∫ßng 2: N·∫øu r·∫£nh nh∆∞ nhau, ∆∞u ti√™n m√¥n c√≥ s·ªë ch·ªó √çT h∆°n (C·∫ßn ƒëƒÉng k√Ω ngay)
                return parseInt(a.seat) - parseInt(b.seat);
            });

            const body = document.getElementById('lookupTableBody');
            body.innerHTML = filtered.map(item => {
                const p = getPhase(item.weeks);
                const load = (p === 1) ? stats.gd1 : stats.gd2;
                const isHeavy = load >= 10;
                const isUrgent = parseInt(item.seat) <= 5; // C·∫£nh b√°o n·∫øu ch·ªó <= 5

                return `
                <tr class="${isHeavy ? 'row-warning' : ''}">
                    <td>${item.regCode}</td>
                    <td style="color:#be123c; font-weight:bold;">${item.classCode}</td>
                    <td>${item.name} ${isHeavy ? '<br><small style="color:red; font-weight:bold;">‚ö†Ô∏è GD' + p + ' D√ÄY (' + load + ' bu·ªïi)</small>' : ''}</td>
                    <td style="${isUrgent ? 'color:red; font-weight:bold;' : ''}">
                        ${item.seat} 
                        ${isUrgent ? '<br><small>üî• S·∫ÆP H·∫æT!</small>' : ''}
                    </td>
                    <td>${item.weeks}</td>
                    <td>${item.sessions.map(s => `<div>${s.day}: ${s.time} (${s.loc})</div>`).join('')}</td>
                    <td style="font-weight:500; color:#0369a1;">${item.teacher}</td>
                    <td><button class="btn-tool" style="background:#059669;" onclick="prepareAdd(${JSON.stringify(item).replace(/"/g, '&quot;')})">Ch·ªçn</button></td>
                </tr>
            `}).join('');
        }

        function prepareAdd(item) {
            tempSubject = item;
            document.getElementById('targetSub').innerText = item.classCode + " - " + item.name;
            openModal('creditModal');
        }

        function addSubject() {
            const tc = document.getElementById('creditInput').value;
            const id = getCourseIdentity(tempSubject.classCode);
            const key = `${id.base}|${id.type}`;

            const isDuplicate = mySchedule.some(s => {
                const sId = getCourseIdentity(s.classCode);
                return `${sId.base}|${sId.type}` === key;
            });

            if (isDuplicate) {
                alert(`L·ªñI: M√¥n ${id.base} (${id.type === 'LT' ? 'L√Ω thuy·∫øt' : 'Th·ª±c h√†nh'}) n√†y ƒë√£ c√≥ trong TKB r·ªìi!`);
                closeModal('creditModal');
                return;
            }

            mySchedule.push({ ...tempSubject, credits: parseInt(tc), id: Date.now() });
            closeModal('creditModal'); closeModal('lookupModal');
            renderMainTable();
        }

        function renderMainTable() {
            const body = document.getElementById('mainTableBody');
            const stats = countSessions();
            document.getElementById('statGD1').innerText = stats.gd1;
            document.getElementById('statGD2').innerText = stats.gd2;
            document.getElementById('totalCredits').innerText = mySchedule.reduce((sum, i) => sum + i.credits, 0);

            if (mySchedule.length === 0) {
                body.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:50px; color:#94a3b8;">Tr·ªëng.</td></tr>';
                return;
            }
            body.innerHTML = mySchedule.map(item => `
                <tr>
                    <td style="font-family:monospace;">${item.regCode}</td>
                    <td style="font-weight:bold; color:#be123c;">${item.classCode}</td>
                    <td style="font-weight:600;">${item.name}<br><small>${item.credits} TC (GD${getPhase(item.weeks)})</small></td>
                    <td>${item.weeks}</td>
                    <td>${item.sessions.map(s => `<div>${s.day} ${s.time}</div>`).join('')}</td>
                    <td>${item.sessions.map(s => `<div>üìç ${s.loc}</div>`).join('')}</td>
                    <td style="font-weight:500; color:#0369a1;">${item.teacher}</td>
                    <td><button style="border:none; color:#ef4444; background:none; cursor:pointer;" onclick="removeSub(${item.id})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `).join('');
        }

        function removeSub(id) { mySchedule = mySchedule.filter(i => i.id !== id); renderMainTable(); }
        function clearAll() { if (confirm("X√≥a h·∫øt?")) { mySchedule = []; renderMainTable(); } }
        function exportData() { if (mySchedule.length === 0) return alert("Tr·ªëng!"); const blob = new Blob([JSON.stringify(mySchedule)], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "LichHoc.json"; a.click(); }
        function importData(input) { const file = input.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { mySchedule = JSON.parse(e.target.result); renderMainTable(); }; reader.readAsText(file); } }
        function generateTKB() { if (mySchedule.length === 0) return alert("Ch∆∞a c√≥ m√¥n!"); const content = document.getElementById('tkbContent'); content.innerHTML = `${renderBox("GIAI ƒêO·∫†N 1 (Tu·∫ßn 21-30)", "#f97316", 21, 30)}${renderBox("GIAI ƒêO·∫†N 2 (Tu·∫ßn 31-40)", "#3b82f6", 31, 40)}`; openModal('tkbModal'); }

        function renderBox(title, color, sW, eW) {
            const days = ["Hai", "Ba", "T∆∞", "NƒÉm", "S√°u", "B·∫£y", "CN"];
            let html = `<div class="tkb-box"><div class="tkb-head" style="background:${color}">${title}</div><table class="tkb-table"><thead><tr><th width="35">Ca</th>${days.map(d => `<th>${d}</th>`).join('')}</tr></thead><tbody>`;
            ["S√°ng", "Chi·ªÅu", "T·ªëi"].forEach(ca => {
                html += `<tr><td style="background:#f8fafc; text-align:center; font-weight:bold;">${ca}</td>`;
                for (let d = 2; d <= 8; d++) {
                    let dStr = d === 8 ? "CN" : "T" + d;
                    let items = [];
                    mySchedule.forEach(sub => {
                        if ((getPhase(sub.weeks) === 1 && sW === 21) || (getPhase(sub.weeks) === 2 && sW === 31)) {
                            sub.sessions.forEach(ss => {
                                let hour = parseInt(ss.start.split(':')[0]);
                                let isCa = (ca === "S√°ng" && hour < 12) || (ca === "Chi·ªÅu" && hour >= 12 && hour < 17) || (ca === "T·ªëi" && hour >= 17);
                                if (ss.day === dStr && isCa) items.push({ code: sub.classCode, time: ss.time, loc: ss.loc });
                            });
                        }
                    });
                    html += `<td>${items.map(i => `<div class="tkb-card"><b>${i.code}</b><br>${i.time}<br><small>üìç ${i.loc}</small></div>`).join('')}</td>`;
                }
                html += `</tr>`;
            });
            return html + `</tbody></table></div>`;
        }

        function snapTable() { snapElement('mainTableArea'); }
        function snapElement(id) { html2canvas(document.getElementById(id)).then(canvas => { canvas.toBlob(blob => { navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]); alert("ƒê√£ copy ·∫£nh!"); }); }); }
    </script>
</body>

</html>
