<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·∫Øp X·∫øp L·ªãch T√≠n Ch·ªâ</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-body: #f8fafc;
            --primary: #be123c;
            --secondary: #047857;
            --text: #334155;
            --card-bg: #ffffff;
            --border-radius: 10px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * {
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        header {
            height: 50px;
            background: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            z-index: 10;
        }

        h1 {
            font-size: 1.1rem;
            color: var(--primary);
            margin: 0;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
        }

        .app-container {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr;
            /* ƒê√£ ch·ªânh t·ª´ 320px 1fr sang 1fr ƒë·ªÉ chi·∫øm h·∫øt m√†n h√¨nh */
            gap: 15px;
            padding: 15px;
            overflow: hidden;
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow: hidden;
        }

        .toolbar {
            background: var(--card-bg);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            flex-shrink: 0;
        }

        .total-badge {
            background: var(--primary);
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .btn-tool {
            padding: 8px 14px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            color: white;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            transition: 0.2s;
        }

        .btn-tool:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
        }

        .table-card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            border: 1px solid #e2e8f0;
        }

        .table-scroll {
            flex: 1;
            overflow: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f1f5f9;
            color: #334155;
            padding: 12px 10px;
            font-size: 0.75rem;
            text-align: left;
            position: sticky;
            top: 0;
            z-index: 10;
            border-bottom: 2px solid #cbd5e1;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.85rem;
            vertical-align: middle;
            color: #334155;
        }

        tr:hover {
            background-color: #f8fafc;
        }

        .tag {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            display: inline-block;
            margin-right: 4px;
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(3px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-box {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 1300px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
            animation: popIn 0.2s;
        }

        .modal-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }

        .modal-body {
            flex: 1;
            display: flex;
            padding: 20px;
            gap: 20px;
            background: #f8fafc;
            overflow: hidden;
        }

        .lookup-left {
            width: 200px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .lookup-right {
            flex: 1;
            background: white;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            overflow: auto;
        }

        .btn-disabled {
            background: #cbd5e1 !important;
            color: #64748b !important;
            cursor: not-allowed !important;
        }

        .alert-box {
            background: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            width: 380px;
            max-width: 90%;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        @keyframes popIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* TKB CSS */
        .tkb-container {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 10px;
            background: #f8fafc;
        }

        .tkb-phase-box {
            flex: 1;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .tkb-phase-header {
            padding: 10px;
            text-align: center;
            font-weight: 800;
            color: white;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }

        .ph1 {
            background: #f97316;
        }

        .ph2 {
            background: #3b82f6;
        }

        .tkb-table-wrap {
            flex: 1;
            overflow: auto;
        }

        .tkb-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }

        .tkb-table th {
            background: #f1f5f9;
            color: #334155;
            border: 1px solid #e2e8f0;
            padding: 8px;
            font-size: 0.75rem;
            text-align: center;
            font-weight: 700;
            height: 35px;
        }

        .tkb-table td {
            border: 1px solid #e2e8f0;
            padding: 2px;
            vertical-align: top;
            height: 100px;
            background: white;
        }

        .tkb-shift-cell {
            background: #fff7ed !important;
            color: #c2410c !important;
            font-weight: 700;
            text-align: center;
            vertical-align: middle !important;
            width: 40px;
            font-size: 0.8rem;
        }

        .tkb-card {
            background: #ecfccb;
            border-left: 3px solid #65a30d;
            padding: 4px;
            margin-bottom: 2px;
            border-radius: 3px;
            font-size: 0.7rem;
            overflow: hidden;
        }

        .tkb-card b {
            color: #15803d;
            display: block;
            margin-bottom: 1px;
            font-size: 0.75rem;
        }

        .tkb-card-loc {
            color: #b91c1c;
            font-weight: 600;
            margin-top: 1px;
        }

        /* BUTTONS */
        .btn-giant {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            border: none;
            padding: 25px;
            border-radius: 12px;
            font-weight: 800;
            cursor: pointer;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.25);
            transition: 0.2s;
            font-size: 1.2rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-giant:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(79, 70, 229, 0.35);
        }

        .btn-clean-del {
            background: #ef4444;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: 0.2s;
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .btn-clean-del:hover {
            background: #dc2626;
        }

        .badge-seat {
            font-weight: 800;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.85rem;
            display: inline-block;
            min-width: 30px;
            text-align: center;
        }

        .seat-low {
            background: #fee2e2;
            color: #b91c1c;
        }

        .seat-high {
            background: #dcfce7;
            color: #15803d;
        }

        .phase-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-top: 4px;
        }

        .p1-badge {
            background-color: #d1ecf1;
            color: #0c5460;
        }

        .p2-badge {
            background-color: #fff3cd;
            color: #856404;
        }

        .p-both-badge {
            background-color: #d4edda;
            color: #155724;
        }

        .btn-submit {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            width: 100%;
            transition: 0.2s;
        }

        .form-group {
            margin-bottom: 10px;
        }

        input,
        select {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            background: #f8fafc;
            font-size: 0.85rem;
        }
    </style>
</head>

<body>

    <header>
        <h1>S·∫Øp X·∫øp L·ªãch T√≠n Ch·ªâ</h1>
    </header>

    <div class="app-container">
        <div class="main-content">
            <div class="toolbar">
                <div style="font-weight:700; color:#374151;">T·ªïng: <span class="total-badge" id="totalCredits">0</span>
                    TC</div>
                <div style="display:flex; gap:8px;">
                    <button class="btn-tool" style="background:#059669;" onclick="openLookupModal()"><i
                            class="fas fa-search"></i> Ch·ªçn m√¥n</button>
                    <button class="btn-tool" style="background:#7c3aed;" onclick="autoQuickImport()"><i
                            class="fas fa-bolt"></i> Nhanh</button>

                    <button class="btn-tool" style="background:#ec4899;" onclick="snapFullTable()"><i
                            class="fas fa-camera"></i> Ch·ª•p b·∫£ng</button>

                    <button class="btn-tool" style="background:#f59e0b;" onclick="openTKB()"><i
                            class="far fa-calendar-alt"></i> TKB</button>
                    <button class="btn-tool" style="background:#0891b2;" onclick="exportData()"><i
                            class="fas fa-save"></i> L∆∞u</button>
                    <button class="btn-tool" style="background:#dc2626;" onclick="clearAll()"><i
                            class="fas fa-trash"></i> X√≥a</button>
                    <input type="file" id="fileInput" hidden accept=".json" onchange="importData(this)">
                    <button class="btn-tool" style="background:#475569;"
                        onclick="document.getElementById('fileInput').click()"><i class="fas fa-folder-open"></i>
                        M·ªü</button>
                </div>
            </div>

            <div class="table-card" id="captureArea">
                <div class="table-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th width="10%">M√£ ƒêK</th>
                                <th width="15%">M√£ L·ªõp</th>
                                <th width="20%">T√™n M√¥n</th>
                                <th width="8%">Tu·∫ßn</th>
                                <th width="12%">L·ªãch H·ªçc</th>
                                <th width="15%">ƒê·ªãa ƒêi·ªÉm</th>
                                <th width="15%">Gi·∫£ng Vi√™n</th>
                                <th width="5%"></th>
                            </tr>
                        </thead>
                        <tbody id="schedBody">
                            <tr>
                                <td colspan="8" style="text-align:center; padding:40px; color:#9ca3af;">Ch∆∞a c√≥ m√¥n n√†o
                                    trong l·ªãch.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="lookupModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <h2 style="margin:0; font-size:1.3rem; color:#1f2937;"><i class="fas fa-book-open"></i> Tra C·ª©u</h2>
                <button onclick="document.getElementById('lookupModal').style.display='none'"
                    style="border:none; background:none; font-size:24px; cursor:pointer; color:#6b7280;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="lookup-left">
                    <button class="btn-giant" onclick="pasteAndAnalyzeLookup()"><i class="fas fa-clipboard-check"></i>
                        D√ÅN</button>
                    <button class="btn-clean-del" onclick="clearLookupData()"><i class="fas fa-trash-alt"></i>
                        X√ìA</button>
                </div>
                <div class="lookup-right">
                    <table style="width:100%;">
                        <thead>
                            <tr>
                                <th>M√£ ƒêK</th>
                                <th>M√£ L·ªõp</th>
                                <th>T√™n M√¥n</th>
                                <th style="width:60px;">Ch·ªó</th>
                                <th>Tu·∫ßn</th>
                                <th>L·ªãch</th>
                                <th>GV</th>
                                <th>Ch·ªçn</th>
                            </tr>
                        </thead>
                        <tbody id="lookupTableBody">
                            <tr>
                                <td colspan="8" style="text-align:center; padding:40px; color:#9ca3af;">Vui l√≤ng d√°n d·ªØ
                                    li·ªáu.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="quickModal" class="modal-overlay">
        <div class="alert-box" style="width:350px; padding:30px;">
            <div style="font-size:3rem; margin-bottom:15px; color:#7c3aed;">‚ö°</div>
            <h2 style="color:#334155; margin:0 0 20px 0;">D√°n Th·ªß C√¥ng</h2>
            <p style="font-size:0.9rem; color:#64748b;">Vui l√≤ng d√°n v√†o ƒë√¢y:</p>
            <textarea id="quickInput"
                style="width:100%; height:120px; border:1px solid #d1d5db; padding:12px; border-radius:8px; font-size:0.8rem;"
                placeholder="Ctrl+V v√†o ƒë√¢y..."></textarea>
            <div style="text-align:right; margin-top:10px;">
                <button onclick="manualAnalyzeQuick()" class="btn-submit"
                    style="width:auto; display:inline-block; background:#7c3aed;">X·ª≠ l√Ω</button>
                <button onclick="document.getElementById('quickModal').style.display='none'" class="btn-submit"
                    style="width:auto; background:#e5e7eb; color:#374151;">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <div id="creditModal" class="modal-overlay">
        <div class="alert-box" style="width:350px; text-align:left;">
            <h3 style="color:#be123c; margin:0 0 10px 0; text-align:center;">S·ªë T√≠n Ch·ªâ</h3>
            <p id="creditSubName"
                style="font-weight:700; font-size:0.95rem; margin:0 0 15px 0; color:#1f2937; text-align:center;"></p>
            <div class="form-group">
                <select id="popupCredits" onchange="toggleCustom(this, 'popupCustomCredits')">
                    <option value="3" selected>3 T√≠n</option>
                    <option value="1">1 T√≠n</option>
                    <option value="2">2 T√≠n</option>
                    <option value="4">4 T√≠n</option>
                    <option value="5">5 T√≠n</option>
                    <option value="6">6 T√≠n</option>
                    <option value="custom" style="color:#be123c; font-weight:bold;">-- Kh√°c --</option>
                </select>
                <input type="number" id="popupCustomCredits" style="display:none; margin-top:10px;"
                    placeholder="Nh·∫≠p s·ªë TC..." autocomplete="off">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="confirmCredit()" class="btn-submit">OK</button>
                <button onclick="document.getElementById('creditModal').style.display='none'" class="btn-submit"
                    style="background:#e5e7eb; color:#374151;">H·ªßy</button>
            </div>
        </div>
    </div>

    <div id="alertModal" class="modal-overlay" style="z-index:9999;">
        <div class="alert-box">
            <div id="alertIcon" style="font-size:40px; margin-bottom:10px;">üîî</div>
            <h3 id="alertMsg" style="margin:10px 0; color:#1f2937; font-size:1rem; line-height:1.5;"></h3>
            <button onclick="document.getElementById('alertModal').style.display='none'" class="btn-submit"
                style="width:auto; padding:10px 30px;">OK</button>
        </div>
    </div>

    <div id="confirmModal" class="modal-overlay" style="z-index:10000;">
        <div class="alert-box">
            <div style="font-size:40px; margin-bottom:10px;">‚ö†Ô∏è</div>
            <h3 id="confirmMsg" style="margin:10px 0; color:#1f2937; font-size:1rem; line-height:1.5;">B·∫°n c√≥ ch·∫Øc ch·∫Øn?
            </h3>
            <div style="display:flex; gap:10px; margin-top:20px; justify-content:center;">
                <button id="confirmYesBtn" class="btn-submit"
                    style="background:#ef4444; width:auto; padding:10px 30px;">X√≥a</button>
                <button onclick="document.getElementById('confirmModal').style.display='none'" class="btn-submit"
                    style="background:#e5e7eb; color:#374151; width:auto; padding:10px 30px;">H·ªßy</button>
            </div>
        </div>
    </div>

    <div id="tkbModal" class="modal-overlay">
        <div class="modal-box" style="max-width:1600px; height:95vh;">
            <div class="modal-header" style="background:#fff7ed;">
                <h2 style="color:#c2410c; margin:0; display:flex; align-items:center; gap:10px;"><i
                        class="far fa-calendar-alt"></i> TH·ªúI KH√ìA BI·ªÇU</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="snapElement('tkbPreviewBody')" class="btn-tool" style="background:#0ea5e9;">üì∏ Ch·ª•p
                        ·∫£nh</button>
                    <button onclick="document.getElementById('tkbModal').style.display='none'"
                        style="border:none; background:none; font-size:24px; cursor:pointer; color:#9ca3af;">&times;</button>
                </div>
            </div>
            <div class="modal-body" id="tkbPreviewBody" style="padding:0;"></div>
        </div>
    </div>

    <script>
        let scheduleData = [], lookupData = [], pendingSelection = null;
        let confirmCallback = null;

        function getRootCode(code) {
            if (!code) return "";
            // T√°ch m√£ l·ªõp th√†nh c√°c ph·∫ßn, v√≠ d·ª•: "CSN 161 P1" -> ["CSN", "161", "P1"]
            let parts = code.trim().replace(/\s+/g, ' ').split(' ');
            if (parts.length < 2) return code.toUpperCase();

            let prefix = (parts[0] + " " + parts[1]).toUpperCase(); // V√≠ d·ª•: "CSN 161"
            let suffix = parts[2] || ""; // V√≠ d·ª•: "P", "P1", "D"

            // KI·ªÇM TRA LOGIC:
            // N·∫øu h·∫≠u t·ªë (m√£ l·ªõp) c√≥ ch·ª©a s·ªë (nh∆∞ P1, L2, P2) -> ƒê√¢y l√† l·ªõp Th·ª±c h√†nh/Th√†nh ph·∫ßn
            if (/\d/.test(suffix)) {
                return prefix + " " + suffix.toUpperCase(); // Tr·∫£ v·ªÅ "CSN 161 P1" (ƒê·ªãnh danh ri√™ng)
            }

            // N·∫øu kh√¥ng c√≥ s·ªë (nh∆∞ P, D, A) -> Coi l√† l·ªõp L√Ω thuy·∫øt chung
            return prefix; // Tr·∫£ v·ªÅ "CSN 161" (D√πng chung ƒë·ªãnh danh ƒë·ªÉ check tr√πng gi·ªØa c√°c l·ªõp l√Ω thuy·∫øt)
        }

        function checkDuplicate(newCode) {
            let rootNew = getRootCode(newCode);
            // T√¨m trong danh s√°ch ƒë√£ ch·ªçn xem c√≥ m√¥n n√†o c√≥ "ƒê·ªãnh danh" gi·ªëng h·ªát kh√¥ng
            return scheduleData.find(existing => getRootCode(existing.code) === rootNew);
        }

        function checkDuplicate(newCode) {
            let rootNew = getRootCode(newCode);
            return scheduleData.find(existing => getRootCode(existing.code) === rootNew);
        }

        function toMin(s) { let [h, m] = s.split(':'); return h * 60 + (+m); }

        async function getClipboardText() {
            try {
                const text = await navigator.clipboard.readText();
                if (!text.trim()) { showAlert("B·ªô nh·ªõ t·∫°m tr·ªëng!", "error"); return null; }
                return text;
            } catch (err) { return null; }
        }

        async function autoQuickImport() {
            const text = await getClipboardText();
            if (text) {
                runQuickLogic(text);
            } else {
                document.getElementById('quickInput').value = '';
                document.getElementById('quickModal').style.display = 'flex';
                document.getElementById('quickInput').focus();
            }
        }

        function manualAnalyzeQuick() { runQuickLogic(document.getElementById('quickInput').value); }

        function showConfirm(msg, callback) {
            document.getElementById('confirmMsg').innerText = msg;
            confirmCallback = callback;
            document.getElementById('confirmModal').style.display = 'flex';
        }

        document.getElementById('confirmYesBtn').onclick = function () {
            if (confirmCallback) confirmCallback();
            document.getElementById('confirmModal').style.display = 'none';
        }

        function openLookupModal() { clearLookupData(); document.getElementById('lookupModal').style.display = 'flex'; }

        async function pasteAndAnalyzeLookup() {
            const text = await getClipboardText();
            if (text) runLookupLogic(text);
            else showAlert("Kh√¥ng th·ªÉ t·ª± ƒë·ªçc Clipboard. H√£y c·∫•p quy·ªÅn ho·∫∑c d√πng ph√≠m t·∫Øt.", "error");
        }

        function clearLookupData() { document.getElementById('lookupTableBody').innerHTML = '<tr><td colspan="8" style="text-align:center; padding:40px; color:#9ca3af;">D·ªØ li·ªáu tr·ªëng.</td></tr>'; }

        function parseRawData(raw) {
            if (!raw || !raw.trim()) return [];
            raw = raw.replace(/Tu·∫ßn h·ªßy:.*(\n|$)/g, " ").replace(/H·ªßy \d+.*(\n|$)/g, " ");
            const noise = ["ƒê·∫†I H·ªåC DUY T√ÇN", "--Ch·ªçn M√£", "Danh s√°ch L·ªõp"];
            noise.forEach(n => raw = raw.split(n)[0] + (raw.split(n)[1] || ""));
            const shortCodeRegex = /([A-Z]{2,}(?:-[A-Z]+)*\s\d{3,}\s[A-Z0-9]+)/g;
            const longCodeRegex = /\b[A-Z0-9]{10,}\b/g;
            let matches = [], results = [];
            let match;
            while ((match = shortCodeRegex.exec(raw)) !== null) matches.push({ code: match[0], index: match.index });

            for (let i = 0; i < matches.length; i++) {
                try {
                    let currentCode = matches[i].code.trim();
                    let block = raw.substring(matches[i].index, (i < matches.length - 1) ? matches[i + 1].index : raw.length);
                    let regCode = "---";
                    let regMatches = block.match(longCodeRegex);
                    if (regMatches) {
                        let valid = regMatches.find(c => c.replace(/\s/g, '') !== currentCode.replace(/\s/g, '') && c.length > 9);
                        if (valid) regCode = valid;
                    }
                    let name = "";
                    let typeMatch = block.substring(currentCode.length).match(/(LEC|LAB|WOR|DEM|STU|\d{2}--\d{2})/);
                    if (typeMatch) {
                        let rawName = block.substring(currentCode.length, currentCode.length + typeMatch.index);
                        name = rawName.replace(/\b[A-Z0-9]{10,}\b/g, "").trim().replace(/^[^a-zA-Z√Ä-·ªπ]+/, "").trim();
                    }
                    if (!name || name.length < 2) name = currentCode;

                    let seatVal = 0;
                    let nearHeader = block.substring(0, 100);
                    if (!nearHeader.toLowerCase().includes("h·∫øt ch·ªó")) {
                        let typeMatchForSeat = nearHeader.match(/(?:LEC|LAB|WOR|DEM)\s+(\d+)/);
                        if (typeMatchForSeat) seatVal = parseInt(typeMatchForSeat[1]);
                    }

                    let weekMatch = block.match(/(\d{1,2})--(\d{1,2})/);
                    let sW = weekMatch ? parseInt(weekMatch[1]) : 0, eW = weekMatch ? parseInt(weekMatch[2]) : 0;
                    let numbers = block.match(/\b[1-9]\b/g);
                    let credit = (numbers && numbers.length > 0) ? parseInt(numbers[numbers.length - 1]) : 3;

                    let lecturer = "";
                    let lines = block.replace(/C√≤n H·∫°n ƒêƒÉng K√Ω|L·ªõp H·ªçc Ch∆∞a B·∫Øt ƒê·∫ßu|L·ªõp H·ªçc ƒê√£ K·∫øt Th√∫c|H·∫øt H·∫°n ƒêƒÉng K√Ω|LEC|LAB|WOR|DEM/g, "").split('\n').filter(l => l.trim().length > 0);
                    for (let k = lines.length - 1; k >= 0; k--) {
                        let line = lines[k].trim();
                        if (line.length > 5 && !/\d/.test(line) && line === line.toUpperCase() && !line.includes("ƒê·ªäA ƒêI·ªÇM") && !line.includes("PH√íNG")) { lecturer = line; break; }
                    }

                    const timeRegex = /(T\d|CN)[\s:]*(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/g;
                    let tMatch, defaultLoc = "Ch∆∞a r√µ";
                    if (block.includes("H√≤a Kh√°nh")) defaultLoc = "H√≤a Kh√°nh Nam";
                    else if (block.includes("Phan Thanh")) defaultLoc = "209 Phan Thanh";
                    else if (block.includes("Quang Trung")) defaultLoc = "K7/25 Quang Trung";
                    else if (block.includes("Nguy·ªÖn VƒÉn Linh")) defaultLoc = "254 Nguy·ªÖn VƒÉn Linh";
                    else if (block.includes("Online")) defaultLoc = "Online";

                    let roomMatch = block.match(/\b\d{3,4}\b/g);
                    let room = roomMatch ? roomMatch[0] : "";

                    while ((tMatch = timeRegex.exec(block)) !== null) {
                        let day = tMatch[1] === 'CN' ? '8' : tMatch[1].replace('T', '');
                        let finalLoc = (room && defaultLoc !== "Online") ? `P.${room} - ${defaultLoc}` : defaultLoc;
                        results.push({ regCode, code: currentCode, name, credits: credit, day, sT: tMatch[2], eT: tMatch[3], sMin: toMin(tMatch[2]), eMin: toMin(tMatch[3]), sW, eW, location: finalLoc, lecturer, seat: seatVal, phase: 0 });
                    }
                } catch (e) { console.error(e); }
            }
            let minStart = 999, maxEnd = 0;
            results.forEach(c => { if (c.sW < minStart) minStart = c.sW; if (c.eW > maxEnd) maxEnd = c.eW; });
            let threshold = (minStart + maxEnd) / 2;
            results.forEach(c => {
                if (c.eW <= threshold + 1) c.phase = 1; else if (c.sW >= threshold - 1) c.phase = 2; else c.phase = 3;
            });
            return results;
        }

        function runLookupLogic(raw) {
            const parsed = parseRawData(raw);
            if (parsed.length === 0) { document.getElementById('lookupTableBody').innerHTML = `<tr><td colspan="8" style="text-align:center; padding:20px;">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!</td></tr>`; return; }
            const grouped = {};
            parsed.forEach(p => { if (!grouped[p.code]) grouped[p.code] = { ...p, schedules: [] }; grouped[p.code].schedules.push(p); });
            lookupData = Object.values(grouped).filter(item => item.seat > 0).sort((a, b) => (a.sW - b.sW) || (a.seat - b.seat));
            const tb = document.getElementById('lookupTableBody'); tb.innerHTML = '';
            lookupData.forEach((item, idx) => {
                let schedStr = item.schedules.map(s => `<div>T${s.day}: ${s.sT}-${s.eT}</div>`).join('');
                let duplicate = checkDuplicate(item.code);
                let btnHTML = duplicate ? `<button class="btn-tool btn-disabled">‚õî ƒê√£ c√≥</button>` : `<button class="btn-tool" style="background:#059669; padding:6px 12px;" onclick="preSelect(${idx})">Ch·ªçn</button>`;
                let phaseBadge = item.phase === 1 ? `<div class="phase-badge p1-badge">Gƒê 1</div>` : (item.phase === 2 ? `<div class="phase-badge p2-badge">Gƒê 2</div>` : `<div class="phase-badge p-both-badge">C·∫£ 2</div>`);
                let tr = document.createElement('tr');
                tr.innerHTML = `<td style="font-family:monospace;">${item.regCode}</td><td style="font-weight:bold; color:#be123c;">${item.code}</td><td style="font-weight:600;">${item.name}</td><td><span class="badge-seat ${item.seat < 5 ? "seat-low" : "seat-high"}">${item.seat}</span></td><td><b>${item.sW}-${item.eW}</b>${phaseBadge}</td><td style="font-size:13px;">${schedStr}</td><td style="font-size:12px;">${item.lecturer}</td><td>${btnHTML}</td>`;
                tb.appendChild(tr);
            });
        }

        function runQuickLogic(raw) {
            const parsed = parseRawData(raw);
            if (parsed.length === 0) return showAlert("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu!", "error");
            const groupedParsed = {}; parsed.forEach(p => { if (!groupedParsed[p.code]) groupedParsed[p.code] = []; groupedParsed[p.code].push(p); });
            let count = 0, duplicates = 0;
            for (let code in groupedParsed) {
                if (checkDuplicate(code)) { duplicates++; continue; }
                let baseId = Date.now() + Math.floor(Math.random() * 1000);
                groupedParsed[code].forEach((s, i) => { scheduleData.push({ id: baseId, subId: baseId + '_' + i, ...s, startT: s.sT, endT: s.eT, startW: s.sW, endW: s.eW }); });
                count++;
            }
            document.getElementById('quickModal').style.display = 'none'; renderTable();
            showAlert(duplicates > 0 ? `ƒê√£ th√™m ${count} m√¥n. B·ªè qua ${duplicates} m√¥n tr√πng!` : `Th√†nh c√¥ng! ƒê√£ th√™m ${count} m√¥n.`, "success");
        }

        function preSelect(idx) {
            pendingSelection = lookupData[idx];
            document.getElementById('creditSubName').innerText = pendingSelection.code + " - " + pendingSelection.name;
            document.getElementById('popupCredits').value = "3";
            document.getElementById('popupCustomCredits').style.display = "none";
            document.getElementById('creditModal').style.display = 'flex';
        }

        function confirmCredit() {
            let val = parseInt(document.getElementById('popupCredits').value);
            if (isNaN(val)) val = parseInt(document.getElementById('popupCustomCredits').value) || 0;
            let baseId = Date.now();
            pendingSelection.schedules.forEach((s, i) => {
                scheduleData.push({ id: baseId, subId: baseId + '_' + i, regCode: pendingSelection.regCode, code: pendingSelection.code, name: pendingSelection.name, credits: val, startW: pendingSelection.sW, endW: pendingSelection.eW, day: s.day, startT: s.sT, endT: s.eT, sMin: s.sMin, eMin: s.eMin, location: pendingSelection.location, lecturer: pendingSelection.lecturer });
            });
            document.getElementById('creditModal').style.display = 'none';
            renderTable(); showAlert(`ƒê√£ th√™m m√¥n: ${pendingSelection.code}`, "success");
        }

        function renderTable() {
            const tb = document.getElementById('schedBody');
            tb.innerHTML = '';

            // 1. Nh√≥m c√°c b·∫£n ghi theo ID m√¥n h·ªçc
            const groupsMap = {};
            scheduleData.forEach(s => {
                if (!groupsMap[s.id]) groupsMap[s.id] = [];
                groupsMap[s.id].push(s);
            });

            // Chuy·ªÉn Map th√†nh Array ƒë·ªÉ s·∫Øp x·∫øp
            let groupsArray = Object.values(groupsMap);

            if (groupsArray.length === 0) {
                tb.innerHTML = `<tr><td colspan="8" style="text-align:center; padding:40px; color:#9ca3af;">Ch∆∞a c√≥ m√¥n n√†o trong l·ªãch.</td></tr>`;
                updateTotal();
                return;
            }

            // 2. LOGIC S·∫ÆP X·∫æP: GD1 -> C·∫£ 2 -> GD2
            groupsArray.sort((a, b) => {
                const itemA = a[0];
                const itemB = b[0];

                // H√†m x√°c ƒë·ªãnh ƒë·ªô ∆∞u ti√™n (S·ªë c√†ng nh·ªè c√†ng n·∫±m tr√™n ƒë·∫ßu)
                const getPriority = (item) => {
                    // D·ª±a tr√™n logic phase ƒë√£ t√≠nh trong parseRawData:
                    // Phase 1: GD1, Phase 2: GD2, Phase 3: C·∫£ 2
                    if (item.phase === 1) return 1; // ∆Øu ti√™n 1: Gƒê1
                    if (item.phase === 3) return 2; // ∆Øu ti√™n 2: C·∫£ 2
                    if (item.phase === 2) return 3; // ∆Øu ti√™n 3: Gƒê2
                    return 4;
                };

                return getPriority(itemA) - getPriority(itemB);
            });

            // 3. Hi·ªÉn th·ªã c√°c nh√≥m ƒë√£ s·∫Øp x·∫øp
            groupsArray.forEach(g => {
                let f = g[0];
                // X√°c ƒë·ªãnh nh√£n hi·ªÉn th·ªã (Badge)
                let phaseTag = '';
                if (f.phase === 1) {
                    phaseTag = '<span class="tag" style="background:#ffedd5; color:#9a3412;">Gƒê1</span>';
                } else if (f.phase === 2) {
                    phaseTag = '<span class="tag" style="background:#dbeafe; color:#1e40af;">Gƒê2</span>';
                } else {
                    phaseTag = '<span class="tag" style="background:#dcfce7; color:#166534;">C·∫£ 2</span>';
                }

                let tr = document.createElement('tr');
                tr.innerHTML = `
            <td style="font-family:monospace;">${f.regCode || '---'}</td>
            <td style="font-weight:bold; color:#be123c;">${f.code}</td>
            <td style="font-weight:600; color:#0369a1;">${f.name}<br><small>${f.credits} t√≠n ch·ªâ</small></td>
            <td><b>${f.startW}-${f.endW}</b><br>${phaseTag}</td>
            <td>${g.map(s => `<div>T${s.day} <b>${s.startT}-${s.endT}</b></div>`).join('')}</td>
            <td>${g.map(s => `<div>üìç ${s.location}</div>`).join('')}</td>
            <td style="font-style:italic;">${f.lecturer}</td>
            <td><button onclick="deleteSubject(${f.id})" style="border:none; background:none; cursor:pointer; color:#ef4444;"><i class="fas fa-trash"></i></button></td>
        `;
                tb.appendChild(tr);
            });

            updateTotal();
        }

        function deleteSubject(id) { showConfirm("X√≥a m√¥n n√†y?", () => { scheduleData = scheduleData.filter(s => s.id !== parseInt(id)); renderTable(); }); }
        function clearAll() { showConfirm("X√≥a TO√ÄN B·ªò l·ªãch?", () => { scheduleData = []; renderTable(); }); }
        function updateTotal() { const unique = new Set(); let sum = 0; scheduleData.forEach(s => { let root = getRootCode(s.code); if (!unique.has(root)) { unique.add(root); sum += s.credits; } }); document.getElementById('totalCredits').innerText = sum; }

        function openTKB() {
            if (scheduleData.length === 0) return showAlert("L·ªãch tr·ªëng!", "error");
            let minW = 100, maxW = 0;
            scheduleData.forEach(s => { if (s.startW < minW) minW = s.startW; if (s.endW > maxW) maxW = s.endW; });
            let splitW = maxW > 40 ? 30 : Math.floor((minW + maxW) / 2);
            document.getElementById('tkbPreviewBody').innerHTML = `<div class="tkb-container">${renderPhaseBox(1, `GIAI ƒêO·∫†N 1 (Tu·∫ßn ${minW}-${splitW})`, "ph1", 1, splitW)}${renderPhaseBox(2, `GIAI ƒêO·∫†N 2 (Tu·∫ßn ${splitW + 1}-${maxW})`, "ph2", splitW + 1, maxW)}</div>`;
            document.getElementById('tkbModal').style.display = 'flex';
        }

        function renderPhaseBox(phaseId, title, headerClass, startW, endW) {
            let html = `<div class="tkb-phase-box"><div class="tkb-phase-header ${headerClass}">${title}</div><div class="tkb-table-wrap"><table class="tkb-table"><thead><tr><th width="40">CA</th><th>HAI</th><th>BA</th><th>T∆Ø</th><th>NƒÇM</th><th>S√ÅU</th><th>B·∫¢Y</th><th>CN</th></tr></thead><tbody>`;
            const shifts = [{ n: "S√°ng", s: 0, e: 720 }, { n: "Chi·ªÅu", s: 720, e: 1020 }, { n: "T·ªëi", s: 1020, e: 1440 }];
            shifts.forEach(shift => {
                html += `<tr><td class="tkb-shift-cell">${shift.n}</td>`;
                for (let d = 2; d <= 8; d++) {
                    let items = scheduleData.filter(s => parseInt(s.day) === d && s.sMin >= shift.s && s.sMin < shift.e && (phaseId === 1 ? s.startW <= endW : s.endW >= startW));
                    html += `<td>${items.map(it => `<div class="tkb-card"><b>${it.code}</b><div>${it.name}</div><div>‚è∞ ${it.startT}-${it.endT}</div><div class="tkb-card-loc">üìç ${it.location}</div></div>`).join('')}</td>`;
                }
                html += `</tr>`;
            });
            return html + `</tbody></table></div></div>`;
        }

        function toggleCustom(sel, id) { document.getElementById(id).style.display = (sel.value === 'custom') ? 'block' : 'none'; }
        function showAlert(m, t) { document.getElementById('alertIcon').innerText = t === 'error' ? 'üò£' : 'üéâ'; document.getElementById('alertMsg').innerHTML = m; document.getElementById('alertModal').style.display = 'flex'; }
        function snapElement(id) {
            const target = document.getElementById(id);
            html2canvas(target, { scale: 1.5 }).then(c => {
                c.toBlob(b => navigator.clipboard.write([new ClipboardItem({ "image/png": b })]).then(() => showAlert("ƒê√£ copy ·∫£nh!", "success")));
            });
        }
        function exportData() { let a = document.createElement('a'); a.href = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(scheduleData)); a.download = "LichHoc.json"; a.click(); }
        function importData(i) { let f = i.files[0]; if (f) { let r = new FileReader(); r.onload = e => { scheduleData = JSON.parse(e.target.result); renderTable(); showAlert("ƒê√£ t·∫£i d·ªØ li·ªáu!", "success"); }; r.readAsText(f); } }
        function snapFullTable() {
            const table = document.querySelector('#captureArea table');
            if (!table || scheduleData.length === 0) {
                return showAlert("B·∫£ng tr·ªëng, kh√¥ng c√≥ g√¨ ƒë·ªÉ ch·ª•p!", "error");
            }

            const btn = event.currentTarget;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang x·ª≠ l√Ω...';
            btn.style.pointerEvents = 'none';

            // 1. T·∫°o b·∫£n sao (clone) c·ªßa b·∫£ng ƒë·ªÉ x·ª≠ l√Ω l·ªói render
            const cloneTable = table.cloneNode(true);

            // 2. C·∫•u h√¨nh b·∫£n sao ƒë·ªÉ html2canvas ƒë·ªçc ch√≠nh x√°c (b·ªè sticky, b·ªè scroll)
            cloneTable.style.position = 'absolute';
            cloneTable.style.top = '-9999px'; // ƒê·∫©y ra kh·ªèi v√πng nh√¨n th·∫•y
            cloneTable.style.left = '-9999px';
            cloneTable.style.width = table.offsetWidth + 'px';

            // Lo·∫°i b·ªè thu·ªôc t√≠nh 'sticky' ·ªü c√°c th·∫ª th trong b·∫£n sao
            cloneTable.querySelectorAll('th').forEach(th => {
                th.style.position = 'static';
            });

            document.body.appendChild(cloneTable);

            // 3. Ti·∫øn h√†nh ch·ª•p b·∫£n sao
            html2canvas(cloneTable, {
                scale: 2, // ·∫¢nh n√©t g·∫•p ƒë√¥i
                useCORS: true,
                backgroundColor: "#ffffff",
                logging: false
            }).then(canvas => {
                canvas.toBlob(blob => {
                    const item = new ClipboardItem({ "image/png": blob });
                    navigator.clipboard.write([item]).then(() => {
                        showAlert("ƒê√£ s·ª≠a l·ªói render v√† copy ·∫£nh th√†nh c√¥ng!", "success");
                        btn.innerHTML = originalText;
                        btn.style.pointerEvents = 'auto';
                    });
                }, 'image/png');

                // 4. D·ªçn d·∫πp b·∫£n sao sau khi ch·ª•p xong
                document.body.removeChild(cloneTable);
            }).catch(err => {
                console.error(err);
                if (document.body.contains(cloneTable)) document.body.removeChild(cloneTable);
                showAlert("L·ªói khi x·ª≠ l√Ω ·∫£nh!", "error");
                btn.innerHTML = originalText;
                btn.style.pointerEvents = 'auto';
            });
        }
    </script>
</body>

</html>
