<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TRA PH√íNG THI</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --dtu-red: #d32f2f;
            --bg-page: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* --- C·∫§U H√åNH THANH CU·ªòN (SCROLLBAR) M·ªöI --- */
        /* Cho ph√©p cu·ªôn m∆∞·ª£t m√† */
        html {
            scroll-behavior: smooth;
        }

        /* T√πy ch·ªânh thanh cu·ªôn cho Webkit (Chrome, Edge, Safari) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 10px;
            /* Chi·ªÅu cao cho thanh cu·ªôn ngang */
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', sans-serif;
            background: var(--bg-page);
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        @media (min-width: 851px) {
            .app-container {
                display: grid;
                grid-template-columns: 340px 1fr;
                height: 100vh;
                width: 100vw;
            }

            .sidebar {
                height: 100vh;
                overflow-y: auto;
                border-right: 1px solid #ddd;
                display: flex;
                flex-direction: column;
            }

            /* Main content cho ph√©p cu·ªôn ngang (auto) */
            .main-content {
                height: 100vh;
                overflow-x: auto;
                /* Hi·ªán thanh cu·ªôn khi c·∫ßn */
                overflow-y: hidden;
                display: flex;
                align-items: flex-start;
                gap: 25px;
                white-space: nowrap;
                padding-bottom: 20px;
                /* Ch·ª´a ch·ªó cho thanh cu·ªôn */
            }

            .card {
                min-width: 400px;
                max-width: 420px;
            }

            .input-wrapper {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
            }

            textarea#mssvIn {
                flex: 1;
                height: 100%;
                resize: none;
            }
        }

        @media (max-width: 850px) {
            .app-container {
                display: flex;
                flex-direction: column;
                height: 100vh;
                overflow-y: auto;
            }

            .sidebar {
                height: auto;
                border-bottom: 5px solid #eee;
                padding-bottom: 30px;
                flex-shrink: 0;
            }

            textarea#mssvIn {
                min-height: 150px;
                height: 150px;
            }

            .main-content {
                display: flex;
                flex-direction: column;
                gap: 20px;
                padding: 15px;
                overflow: visible;
                flex-shrink: 0;
            }

            .card {
                width: 100%;
                min-width: 0;
                max-width: 100%;
            }

            .guide-grid {
                grid-template-columns: 1fr !important;
            }

            .guide-container {
                width: 100% !important;
                padding: 20px !important;
            }
        }

        .sidebar {
            background: #fff;
            padding: 20px;
            z-index: 10;
            box-sizing: border-box;
        }

        h2 {
            color: var(--dtu-red);
            font-weight: 900;
            text-align: center;
            margin: 0 0 10px 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            font-size: 20px;
        }

        .label {
            font-size: 11px;
            font-weight: 800;
            color: #444;
            text-transform: uppercase;
            margin-bottom: 5px;
            display: block;
        }

        input[type="text"] {
            width: 100%;
            padding: 10px;
            border: 1.5px solid #ccc;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            box-sizing: border-box;
        }

        textarea#mssvIn {
            width: 100%;
            padding: 12px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            font-family: monospace;
            font-weight: bold;
            color: #333;
            box-sizing: border-box;
            overflow-y: auto;
            /* Cho ph√©p cu·ªôn d·ªçc trong √¥ nh·∫≠p */
        }

        textarea#mssvIn:focus {
            border-color: var(--dtu-red);
            outline: none;
            background: #fffcfc;
        }

        .suggestion-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 2px;
            max-height: 150px;
            overflow-y: auto;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            display: none;
            z-index: 1000;
        }

        .suggestion-item {
            padding: 10px 15px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            color: #333;
            text-align: left;
        }

        .suggestion-item:hover {
            background: #fff0f0;
            color: var(--dtu-red);
        }

        .match-text {
            color: var(--dtu-red);
        }

        .btn-paste {
            width: 100%;
            margin-top: 5px;
            background: var(--dtu-red);
            color: white;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-clear-link {
            background: #eee;
            color: #333;
            border: 1px solid #ddd;
            padding: 0 12px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            margin-left: 5px;
        }

        .btn-del-all {
            width: 100%;
            margin-top: 8px;
            background: #fff0f0;
            color: var(--dtu-red);
            border: 1px solid #ffcdd2;
            padding: 10px;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            font-size: 12px;
        }

        .file-box {
            border: 2px dashed #ccc;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
        }

        input[type="file"] {
            width: 100%;
            font-size: 11px;
            cursor: pointer;
        }

        .main-content {
            padding: 30px;
            box-sizing: border-box;
        }

        .guide-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .guide-container {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 90%;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .guide-title {
            font-size: 20px;
            color: var(--dtu-red);
            font-weight: 900;
            text-transform: uppercase;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }

        .guide-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: left;
        }

        .guide-step {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #eee;
        }

        .guide-head {
            font-weight: 900;
            color: #333;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .guide-body {
            font-size: 12px;
            color: #666;
            line-height: 1.5;
        }

        .hl {
            color: var(--dtu-red);
            font-weight: bold;
            background: #fff0f0;
            padding: 2px 5px;
            border-radius: 3px;
        }

        .guide-footer {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #eee;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .copyright-text {
            color: var(--dtu-red);
            font-weight: 900;
            font-size: 14px;
            text-transform: uppercase;
        }

        .qr-code {
            width: 350px;
            height: 350px;
            object-fit: contain;
            border-radius: 10px;
            border: 1px solid #eee;
            background: #fff;
            padding: 5px;
        }

        .card {
            background: #fff;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.08);
            flex-shrink: 0;
            -webkit-font-smoothing: antialiased;
            overflow: hidden;
            margin-bottom: 0;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from {
                transform: scale(0.95);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .c-header {
            background: var(--dtu-red);
            color: white;
            padding: 12px;
            text-align: center;
            font-weight: 900;
            font-size: 16px;
        }

        .c-body {
            padding: 20px;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
            font-size: 14px;
        }

        .val {
            font-weight: 800;
            color: #000;
            text-align: right;
            max-width: 65%;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .hl-box {
            background: #fffdeb;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ffe58f;
            margin-top: 15px;
        }

        .warn {
            color: red !important;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            50% {
                opacity: 0.5;
            }
        }

        .btn-shot {
            width: 100%;
            padding: 12px;
            background: #2d3436;
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            margin-top: 5px;
        }

        #toast-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            background: #fff;
            border-left: 5px solid #333;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            border-radius: 4px;
            font-weight: bold;
            font-size: 13px;
            animation: slideInRight 0.3s;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .t-ok {
            border-color: #00b894;
        }

        .t-err {
            border-color: #d63031;
        }
    </style>
</head>

<body>
    <div id="toast-box"></div>
    <div class="app-container">
        <div class="sidebar">
            <h2>TRA PH√íNG THI NHANH</h2>
            <div style="margin-bottom: 10px;">
                <label class="label">1. D√°n Link Online:</label>
                <div style="display:flex;">
                    <input type="text" id="urlIn" placeholder="Link PDF/Excel..." autocomplete="off">
                    <button class="btn-clear-link" onclick="resetAll()" title="X√≥a Link">‚úï</button>
                </div>
                <button class="btn-paste" id="btnLink" onclick="pasteAndLoad()">üöÄ D√ÅN</button>
            </div>
            <div style="text-align:center; font-size:10px; color:#aaa; font-weight:bold; margin: 5px 0;">--- HO·∫∂C ---
            </div>
            <div style="margin-bottom: 15px;">
                <label class="label">2. T·∫£i File T·ª´ M√°y:</label>
                <div class="file-box"><input type="file" id="fileIn" accept=".xlsx, .xls, .pdf"></div>
            </div>
            <hr style="width:100%; border:0; border-top:1px solid #eee; margin-bottom: 15px;">
            <div class="input-wrapper">
                <label class="label" style="color:var(--dtu-red);">3. Nh·∫≠p MSSV (D√°n nhi·ªÅu d√≤ng):</label>
                <textarea id="mssvIn" inputmode="decimal"
                    placeholder="Nh·∫≠p MSSV (Ph√¢n c√°ch b·∫±ng Enter, d·∫•u ph·∫©y, ho·∫∑c ch·∫•m)..." disabled></textarea>
                <div id="suggestions" class="suggestion-list"></div>
                <button class="btn-del-all" onclick="clearMSSVOnly()">üóëÔ∏è X√ìA DANH S√ÅCH</button>
            </div>
        </div>

        <div class="main-content" id="resultArea">
            <div id="guideView" class="guide-wrapper">
                <div class="guide-container">
                    <div class="guide-title">H∆∞·ªõng D·∫´n S·ª≠ D·ª•ng</div>
                    <div class="guide-grid">
                        <div class="guide-step">
                            <div class="guide-head" style="color:#2980b9;">üîó C√ÅCH 1: D√ôNG LINK</div>
                            <div class="guide-body">1. V√†o trang danh s√°ch thi t·∫°i ph√≤ng ƒë√†o t·∫°o Duy T√¢n.<br>2. Chu·ªôt
                                ph·∫£i t√™n file l·ªãch
                                thi.<br>3. Ch·ªçn <span class="hl">Sao ch√©p ƒë·ªãa ch·ªâ li√™n k·∫øt</span>.<br>4. D√°n v√†o √¥ s·ªë 1
                                v√† ·∫•n <b>üöÄ D√ÅN</b>.</div>
                        </div>
                        <div class="guide-step">
                            <div class="guide-head" style="color:#27ae60;">üìÇ C√ÅCH 2: D√ôNG FILE</div>
                            <div class="guide-body">1. T·∫£i file Excel/PDF v·ªÅ m√°y.<br>2. B·∫•m v√†o √¥ s·ªë 2 <span
                                    class="hl">Ch·ªçn t·ªáp</span> ƒë·ªÉ t·∫£i l√™n.<br><i>(D√πng khi link b·ªã l·ªói).</i></div>
                        </div>
                    </div>
                    <div class="guide-footer">
                        <div class="copyright-text">B·∫£n quy·ªÅn thu·ªôc T√¢n v√† https://t.me/Dai_Hoc_Duy_Tan</div>
                        <img src="maqrtelegram1.jpg" class="qr-code" alt="QR Telegram"
                            onerror="this.style.display='none'">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
        let db = []; let isPDF = false; let processedExams = new Set();

        window.onload = () => { resetAll(); }

        function toast(msg, type = 't-ok') {
            const b = document.getElementById('toast-box');
            const d = document.createElement('div');
            d.className = `toast ${type}`; d.innerText = msg;
            b.appendChild(d); setTimeout(() => d.remove(), 3000);
        }

        function resetAll() { document.getElementById('urlIn').value = ''; document.getElementById('fileIn').value = ''; clearMSSVOnly(); }

        function clearMSSVOnly() {
            document.getElementById('mssvIn').value = '';
            document.getElementById('suggestions').style.display = 'none';
            document.getElementById('mssvIn').focus();
            showGuide(true);
        }

        function showGuide(show) {
            const area = document.getElementById('resultArea'); const guide = document.getElementById('guideView');
            if (show) { Array.from(area.children).forEach(child => { if (child.id !== 'guideView') area.removeChild(child); }); guide.style.display = 'flex'; } else { guide.style.display = 'none'; }
        }

        async function pasteAndLoad() {
            try { const t = await navigator.clipboard.readText(); if (t) document.getElementById('urlIn').value = t; } catch (e) { }
            const url = document.getElementById('urlIn').value.trim();
            const btn = document.getElementById('btnLink');
            if (url.length < 5) return toast("Link l·ªói!", "t-err");
            clearMSSVOnly(); btn.disabled = true; btn.innerText = "‚è≥...";
            const proxies = [`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, `https://corsproxy.io/?${encodeURIComponent(url)}`, `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`];
            let success = false;
            for (let p of proxies) {
                try {
                    const res = await fetch(p); if (!res.ok) throw new Error();
                    const blob = await res.blob(); if (blob.type.includes("html") && blob.size < 5000) throw new Error();
                    isPDF = url.toLowerCase().includes(".pdf"); if (isPDF) await parsePDF(blob); else await parseExcel(blob);
                    success = true; break;
                } catch (e) { }
            }
            btn.disabled = false; btn.innerText = "üöÄ D√ÅN";
            if (!success) { toast("‚ùå Link ch·∫∑n. T·∫£i file v·ªÅ m√°y!", "t-err"); window.open(url, '_blank'); }
        }

        document.getElementById('fileIn').addEventListener('change', async (e) => {
            const f = e.target.files[0]; if (!f) return;
            clearMSSVOnly(); isPDF = f.name.toLowerCase().endsWith(".pdf");
            try { if (isPDF) await parsePDF(f); else await parseExcel(f); } catch (e) { toast("L·ªói file!", "t-err"); }
        });

        // --- H√ÄM EXCEL M·ªöI: FIX L·ªñI S·ªê D√íNG (D√ôNG !ref) ---
        async function parseExcel(blob) {
            const data = await blob.arrayBuffer();
            const wb = XLSX.read(data, { type: 'array' });
            db = [];

            wb.SheetNames.forEach(sheetName => {
                const sheet = wb.Sheets[sheetName];
                // T√≠nh to√°n d√≤ng b·∫Øt ƒë·∫ßu d·ª±a tr√™n v√πng d·ªØ li·ªáu (Range)
                // V√≠ d·ª•: A3:E100 -> startRow = 2 (d√≤ng 3)
                let startRow = 0;
                if (sheet['!ref']) {
                    const range = XLSX.utils.decode_range(sheet['!ref']);
                    startRow = range.s.r;
                }

                const sheetData = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

                sheetData.forEach((row, index) => {
                    row._sheetName = sheetName;
                    // CH·ªàNH L·∫†I C√ÅCH T√çNH S·ªê D√íNG
                    row._realRowIndex = startRow + index + 1;
                    db.push(row);
                });
            });
            toast(`üìÇ ƒê√£ n·∫°p ${wb.SheetNames.length} m√¥n thi`, "t-ok"); enableInput();
        }

        async function parsePDF(blob) {
            const data = await blob.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(data) }).promise;
            let tmp = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const p = await pdf.getPage(i);
                const c = await p.getTextContent();
                const l = {};
                c.items.forEach(it => {
                    const y = Math.round(it.transform[5] / 2) * 2;
                    if (!l[y]) l[y] = [];
                    l[y].push(it);
                });
                Object.keys(l).sort((a, b) => b - a).forEach(y => {
                    let row = l[y].sort((a, b) => a.transform[4] - b.transform[4]).map(x => x.str.trim()).filter(s => s !== "");

                    // CHU·∫®N H√ìA CHO PDF: G·∫Øn nh√£n ƒë·ªÉ renderCard nh·∫≠n bi·∫øt
                    row._isPDF = true;
                    row._sheetName = `Trang ${i}`;
                    tmp.push(row);
                });
            }
            db = tmp;
            toast(`üìÇ ƒê√£ n·∫°p PDF (${pdf.numPages} trang)`, "t-ok");
            enableInput();
        }

        function enableInput() { document.getElementById('mssvIn').disabled = false; document.getElementById('mssvIn').focus(); }

        const inputEl = document.getElementById('mssvIn');
        const suggestDiv = document.getElementById('suggestions');

        inputEl.addEventListener('input', (e) => {
            let val = e.target.value;
            val = val.replace(/[^0-9\n.,]/g, '');
            e.target.value = val;
            const tokens = val.split(/[^0-9]+/);
            const lastToken = tokens[tokens.length - 1];
            handleSuggestions(lastToken);
            autoSearch(val);
        });

        function handleSuggestions(val) {
            if (!val || !db.length || val.length < 3) { suggestDiv.style.display = "none"; return; }
            const matches = new Set();
            for (let row of db) {
                let mssvCell = row.find(c => !isNaN(String(c)) && String(c).length > 5);
                if (mssvCell) {
                    let s = String(mssvCell).trim();
                    if (s.startsWith(val)) matches.add(s);
                }
                if (matches.size >= 5) break;
            }
            if (matches.size > 0) {
                suggestDiv.innerHTML = ""; suggestDiv.style.display = "block";
                matches.forEach(m => {
                    const d = document.createElement('div'); d.className = 'suggestion-item';
                    d.innerHTML = `<span class="match-text">${val}</span>${m.substring(val.length)}`;
                    d.onclick = () => {
                        let currentText = inputEl.value;
                        inputEl.value = currentText.replace(/\d+$/, m);
                        suggestDiv.style.display = "none";
                        autoSearch(inputEl.value);
                        inputEl.focus();
                    };
                    suggestDiv.appendChild(d);
                });
            } else suggestDiv.style.display = "none";
        }

        function autoSearch(val) {
            const keys = val.split(/[^0-9]+/).filter(k => k.length >= 3);
            if (keys.length === 0) { showGuide(true); return; }

            const guide = document.getElementById('guideView'); if (guide) guide.style.display = 'none';
            const area = document.getElementById('resultArea');
            Array.from(area.children).forEach(child => { if (child.id !== 'guideView') area.removeChild(child); });

            processedExams.clear();

            db.forEach((row) => {
                const matchKey = keys.find(k => {
                    return row.some(cell => {
                        const s = String(cell).trim();
                        return s === k || (k.length >= 5 && s.endsWith(k) && s.length >= 5);
                    });
                });
                if (matchKey) renderCard(row, matchKey);
            });
        }

        function renderCard(row, matchedKey) {
            let sheetName = row._sheetName || "Danh s√°ch chung";
            let d = "", t = "", p = "---", cs = "";
            let rawStr = "";

            let dbIdx = db.indexOf(row);
            for (let j = dbIdx; j >= Math.max(0, dbIdx - 50); j--) {
                let rStr = db[j].join(" ");
                if (rStr.includes("Th·ªùi gian:") || rStr.includes("Ph√≤ng:") || (rStr.includes("Ng√†y") && rStr.includes("Ph√≤ng"))) {
                    rawStr = rStr;
                    break;
                }
            }

            if (rawStr) {
                let tMatch = rawStr.match(/(\d{1,2}h\d{2})/); if (tMatch) t = tMatch[1];
                let dMatch = rawStr.match(/(\d{1,2}\/\d{1,2}\/\d{4})/); if (dMatch) d = dMatch[1];
                let pMatch = rawStr.match(/Ph√≤ng:?\s*([^‚Äì-]*)/i);
                if (pMatch && pMatch[1]) p = pMatch[1].trim();
                let csKeywords = ["H√≤a Kh√°nh", "Quang Trung", "Phan Thanh", "Vi·ªát Tr·ª±c"];
                csKeywords.forEach(k => { if (rawStr.includes(k)) cs = k; });
            }

            let msvIdx = row.findIndex(cell => {
                let s = String(cell).trim();
                return s === matchedKey || (matchedKey.length >= 5 && s.endsWith(matchedKey));
            });

            if (msvIdx === -1) return;

            let msv = String(row[msvIdx]).trim();
            let rowIdx = row._realRowIndex || (dbIdx + 1);
            let stt = row[msvIdx - 1] || "";
            let fullName = (String(row[msvIdx + 1] || "") + " " + String(row[msvIdx + 2] || "")).replace(/[0-9]/g, '').replace(/\s+/g, ' ').trim();

            // --- LOGIC S·ª¨A L·ªñI PDF ---
            let lopHP = "";
            let lopSH = "";

            if (row._isPDF) {
                // ƒê·ªëi v·ªõi PDF: T√¨m c√°c chu·ªói c√≥ ƒë·ªãnh d·∫°ng m√£ l·ªõp (v√≠ d·ª•: SOC 151, HIS 362 ho·∫∑c K30VTD)
                // L·ªõp HP th∆∞·ªùng ch·ª©a m√£ m√¥n h·ªçc (v√≠ d·ª•: SOC 151 A)
                lopHP = row.find(c => /^[A-Z]{3,4}\s\d{3}/.test(String(c))) || "";
                // L·ªõp SH th∆∞·ªùng b·∫Øt ƒë·∫ßu b·∫±ng ch·ªØ K (v√≠ d·ª•: K30VTD)
                lopSH = row.find(c => /^K\d{2}/.test(String(c))) || "";
            } else {
                // Gi·ªØ nguy√™n logic Excel hi·ªán t·∫°i c·ªßa b·∫°n
                lopHP = String(row[5] || "").trim();
                lopSH = String(row[6] || "").trim();
            }

            let realNote = "";
            let warnClass = "";
            for (let i = 0; i < row.length; i++) {
                let txt = String(row[i] || "").trim().toLowerCase();
                if (txt.includes("n·ª£") || txt.includes("c·∫•m") || txt.includes("hp") || txt.includes("v·∫Øng")) {
                    realNote = String(row[i]).trim();
                    warnClass = "warn";
                    break;
                }
            }

            const area = document.getElementById('resultArea');
            const div = document.createElement('div');
            div.className = 'card';

            div.innerHTML = `
        <div class="copyright-header" style="display: none; text-align: center; background: #f8f9fa; color: #6c757d; font-size: 10px; padding: 5px; font-weight: bold; border-bottom: 1px solid #eee;">
            B·∫£n quy·ªÅn thu·ªôc T√¢n & https://t.me/Dai_Hoc_Duy_Tan
        </div>

        <div class="c-header" style="background: #d32f2f; font-family: 'Segoe UI', sans-serif; letter-spacing: 1.5px; text-transform: uppercase; font-weight: 900;">TH√îNG TIN D·ª∞ THI</div>
        
        <div class="c-body" style="padding: 15px; background: #ffffff; display: flex; flex-direction: column; gap: 12px;">
            <div style="font-size: 11px; color: #7f8c8d; display: flex; align-items: center; gap: 5px;">
                <span style="font-size: 14px;">üìÇ</span> <b>NGU·ªíN:</b> <span style="color: #2c3e50;">${sheetName}</span>
            </div>

            <div style="display: flex; gap: 10px;">
                <div style="flex: 1; background: #f0f7ff; border: 1.5px solid #007bff; border-radius: 12px; padding: 10px; text-align: center;">
                    <div style="font-size: 11px; color: #007bff; font-weight: bold; margin-bottom: 4px;">üóìÔ∏è NG√ÄY THI</div>
                    <div style="font-size: 17px; color: #004085; font-weight: 900;">${d}</div>
                </div>
                <div style="flex: 1; background: #fff5eb; border: 1.5px solid #fd7e14; border-radius: 12px; padding: 10px; text-align: center;">
                    <div style="font-size: 11px; color: #fd7e14; font-weight: bold; margin-bottom: 4px;">‚è∞ GI·ªú THI</div>
                    <div style="font-size: 17px; color: #856404; font-weight: 900;">${t}</div>
                </div>
            </div>

            <div style="text-align: center;">
                <div style="font-size: 12px; color: #7f8c8d; font-weight: bold; text-transform: uppercase;">PH√íNG THI</div>
                <div style="font-size: 32px; color: #d32f2f; font-weight: 900; line-height: 1.1; margin: 2px 0;">${p}</div>
                <div style="font-size: 14px; color: #2c3e50; font-weight: 800;">üìç C∆† S·ªû: ${cs}</div>
            </div>

            <div style="display: flex; align-items: center; justify-content: center; background: #28a745; color: #fff; border-radius: 8px; padding: 10px; box-shadow: 0 4px 10px rgba(40, 167, 69, 0.2);">
                <span style="font-size: 11px; text-transform: uppercase; margin-right: 12px; font-weight: bold; letter-spacing: 1px;">M√É SV:</span>
                <span style="font-size: 20px; font-weight: 900; letter-spacing: 2px; font-family: monospace;">${msv}</span>
            </div>

            <div style="width: 100%; border: 1.5px solid #2c3e50; border-radius: 12px; overflow: hidden; background: #fff;">
                <table style="width: 100%; border-collapse: collapse; table-layout: fixed;">
                    <thead>
                        <tr style="font-size: 10px; font-weight: bold; text-align: center; border-bottom: 1.5px solid #2c3e50; background: #f8f9fa;">
                            <th style="border-right: 1.5px solid #2c3e50; padding: 8px 2px; width: 12%;">STT</th>
                            <th style="border-right: 1.5px solid #2c3e50; padding: 8px 4px; width: 45%;">H·ªå V√Ä T√äN</th>
                            <th style="border-right: 1.5px solid #2c3e50; padding: 8px 2px; width: 21.5%;">L·ªöP H·ªåC<br>PH·∫¶N</th>
                            <th style="padding: 8px 2px; width: 21.5%;">L·ªöP SH</th>
                        </tr>
                    </thead>
                    <tbody style="font-size: 13px; font-weight: 800; color: #000;">
                        <tr style="min-height: 60px; text-align: center;">
                            <td style="border-right: 1.5px solid #2c3e50; vertical-align: middle;">${stt}</td>
                            <td style="border-right: 1.5px solid #2c3e50; padding: 8px 4px; vertical-align: middle; overflow-wrap: break-word; line-height: 1.2; font-size: ${fullName.length > 20 ? '11px' : '13px'};">
                                ${fullName}
                            </td>
                            <td style="border-right: 1.5px solid #2c3e50; font-weight: 600; font-size: 11px; color: #16a085; vertical-align: middle;">${lopHP}</td>
                            <td style="font-size: 11px; font-weight: 600; color: #2980b9; vertical-align: middle;">${lopSH}</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 18px; background: #f5f0ff; border-radius: 12px; border: 1.5px dashed #6f42c1;">
                <span style="font-weight: bold; color: #6f42c1; font-size: 16px;">V·ªä TR√ç H√ÄNG</span>
                <span style="color: #6f42c1; font-size: 38px; font-weight: 950; line-height: 1;">${rowIdx}</span>
            </div>

            ${realNote && realNote.toUpperCase().includes("N·ª¢ HP") ? `
            <div style="border-radius: 10px; overflow: hidden; border: 1.5px solid #f5c6cb; background: #fff;">
                <div style="background: #f8d7da; padding: 8px 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px dashed #f5c6cb;">
                    <span style="font-size: 18px; flex-shrink: 0;">‚ö†Ô∏è</span>
                    <span style="color: #721c24; font-size: 13px; font-weight: 900; text-transform: uppercase;">
                        GHI CH√ö: ${realNote}
                    </span>
                </div>
                <div style="padding: 10px 12px; display: flex; align-items: flex-start; gap: 10px;">
                    <span style="font-size: 18px; flex-shrink: 0;">üö´</span>
                    <div style="color: #1b1e21; font-size: 11px; font-weight: 800; line-height: 1.4; white-space: normal; word-break: break-word; flex: 1;">
                        <span style="color: #d32f2f; text-decoration: underline;">NH·∫ÆC NH·ªû:</span> 
                        SINH VI√äN CH∆ØA ƒê√ìNG H·ªåC PH√ç <span style="color: #d32f2f;">KH√îNG ƒê∆Ø·ª¢C PH√âP</span> V√ÄO PH√íNG THI.
                    </div>
                </div>
            </div>
            ` : ''}

<div class="disclaimer-footer" style="display: none; margin-top: 15px; padding: 10px 12px; background: #fffef0; border: 1px solid #ffe58f; border-radius: 8px; font-size: 10.5px; color: #856404; line-height: 1.5; text-align: center; font-weight: bold; white-space: normal; word-break: break-word; width: auto;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 2px;">
                    <span style="font-size: 14px;">‚ö†Ô∏è</span> <span>MI·ªÑN TR·ª™ TR√ÅCH NHI·ªÜM</span>
                </div>
                Th√¥ng tin mang t√≠nh ch·∫•t tra c·ª©u nhanh. Sinh vi√™n vui l√≤ng t·ª± ki·ªÉm tra l·∫°i danh s√°ch thi ch√≠nh th·ª©c t·∫°i website Ph√≤ng ƒê√†o t·∫°o ƒë·ªÉ ƒë·∫£m b·∫£o ƒë·ªô ch√≠nh x√°c tuy·ªát ƒë·ªëi.
            </div>
        </div>
        <button class="btn-shot" style="background: #2c3e50; color: #fff; width: 100%; border: none; padding: 15px; font-weight: 900; border-radius: 0 0 16px 16px; cursor: pointer; font-size: 14px; text-transform: uppercase;" onclick="capture(this.parentElement)">üì∏ CH·ª§P ·∫¢NH L∆ØU L·∫†I</button>
    `;

            area.appendChild(div);
        }

        async function capture(el) {
            const btn = el.querySelector('button');
            const copyright = el.querySelector('.copyright-header');
            const disclaimer = el.querySelector('.disclaimer-footer');

            // Hi·ªán c√°c ph·∫ßn ·∫©n khi ch·ª•p
            btn.style.display = "none";
            if (copyright) copyright.style.display = "block";
            if (disclaimer) disclaimer.style.display = "block";

            const originalAnimation = el.style.animation;
            el.style.animation = "none";

            const canvas = await html2canvas(el, { scale: 6, backgroundColor: "#ffffff", useCORS: true });

            // ·∫®n l·∫°i sau khi ch·ª•p xong
            el.style.animation = originalAnimation;
            if (copyright) copyright.style.display = "none";
            if (disclaimer) disclaimer.style.display = "none";
            btn.style.display = "block";

            canvas.toBlob(blob => {
                navigator.clipboard.write([new ClipboardItem({ "image/png": blob })]);
                toast("üì∏ ƒê√£ ch·ª•p v√† sao ch√©p v√†o Clipboard!", "t-ok");
            }, 'image/png', 1.0);
        }
    </script>
</body>

</html>
